<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>辛巴成长记</title>
  
  <subtitle>little Simba</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-12-12T06:26:02.716Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>lvxiaohai99</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>hexo-new-article</title>
    <link href="http://yoursite.com/2018/12/12/hexo-new-article/"/>
    <id>http://yoursite.com/2018/12/12/hexo-new-article/</id>
    <published>2018-12-12T06:21:15.000Z</published>
    <updated>2018-12-12T06:26:02.716Z</updated>
    
    <content type="html"><![CDATA[<h1 id="seckill"><a href="#seckill" class="headerlink" title="seckill"></a>seckill</h1><p>一个整合SSM框架的高并发和商品秒杀项目,学习目前较流行的Java框架组合实现高并发秒杀API</p><h2 id="项目的来源"><a href="#项目的来源" class="headerlink" title="项目的来源"></a>项目的来源</h2><p>项目的来源于国内IT公开课平台,质量没的说,很适合学习一些技术的基础,这个项目是由四个系列的课程组成的,流程分为几个流程,很基础地教你接触到一个相对有技术含量的项目</p><ul><li>Java高并发秒杀API之业务分析与DAO层</li><li>Java高并发秒杀API之web层</li><li>Java高并发秒杀API之Service层</li><li>Java高并发秒杀API之高并发优化</li></ul><p>其实这几个流程也就是开发的流程,首先从DAO层开始开发,从后往前开发,开始Coding吧！</p><h2 id="项目环境的搭建"><a href="#项目环境的搭建" class="headerlink" title="项目环境的搭建"></a>项目环境的搭建</h2><ul><li><strong>操作系统</strong> : Ubuntu 17.04</li><li><strong>IDE</strong> ：IntelliJ IDEA 2016.2.5 x64 用Eclipse也一样的,工具时靠人用的</li><li><strong>JDK</strong> : JDK1.8 建议使用JDK1.7以上版本,有许多语法糖用着挺舒服的</li><li><strong>Web容器</strong> ： Tomcat 8.0</li><li><strong>数据库</strong> ：Mysql-5.6.17-WinX64    实验性的项目用Mysql就足够啦</li><li><p><strong>依赖管理工具</strong> : Maven  管理jar包真的很方便  </p><p>这里列出的环境不是必须的,你喜欢用什么就用什么,这里只是给出参考,不过不同的版本可能会引起各种不同的问题就需要我们自己去发现以及排查,在这里使用Maven的话时方便我们管理JAR包,我们不用跑去各种开源框架的官网去下载一个又一个的JAR包,配置好了Maven后添加pom文件坐标就会从中央仓库下载JAR包,如果哪天替换版本也很方便</p></li></ul><hr><h2 id="项目效果图"><a href="#项目效果图" class="headerlink" title="项目效果图"></a>项目效果图</h2><ul><li>秒杀商品列表  </li></ul><p><img src="/images/result_1.jpg" alt="效果图">  </p><ul><li>秒杀结束提示界面  </li></ul><p><img src="/images/result_2.jpg" alt="效果图">  </p><ul><li>开始秒杀提示界面  </li></ul><p><img src="/images/result_3.jpg" alt="效果图"></p><ul><li>重复秒杀提示界面  </li></ul><p><img src="/images/result_4.jpg" alt="效果图">  </p><ul><li>秒杀秒杀成功提示界面  </li></ul><p><img src="/images/result_5.jpg" alt="效果图">  </p><hr><h2 id="项目的运行"><a href="#项目的运行" class="headerlink" title="项目的运行"></a>项目的运行</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><code>Download Zip</code>或者 <code>git clone</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Sunybyjava/seckill.git</span><br></pre></td></tr></table></figure></p><h3 id="导入到IDE"><a href="#导入到IDE" class="headerlink" title="导入到IDE"></a>导入到IDE</h3><p>这里因为是使用<code>IDEA</code>创建的项目,所以使用<code>IDEA</code>直接打开是很方便的,提前是你要配置好<code>maven</code>的相关配置,以及项目<code>JDK</code>版本,<br><code>JDK</code>版本必须在<code>1.8</code>以上,因为在项目中使用了<code>Java8</code>的<code>LocalDateTime</code>以及<code>LocalDate</code>,所以低于这个版本编译会失败的</p><ul><li>IDEA<br>直接在主界面选择<code>Open</code>,然后找到项目所在路径,点击<code>pom.xml</code>打开就可以了</li><li>Eclipse<br>这个项目是基于<code>IDEA</code>创建,我这里把项目转成了<code>Eclipse</code>的项目,如果你使用Eclipse的话也可以直接导入,只是步骤更繁琐一点,<a href="/note/EclipseImport.md">Eclipse导入步骤</a></li></ul><h2 id="项目编码"><a href="#项目编码" class="headerlink" title="项目编码"></a>项目编码</h2><p>项目总结可能比较的长,<strong>密集恐惧症</strong>者请按小节进行阅读  </p><ul><li><a href="/note/note1.md">(一)Java高并发秒杀API之业务分析与DAO层</a></li><li><a href="/note/note2.md">(二)Java高并发秒杀API之Service层</a></li><li><a href="/note/note3.md">(三)Java高并发秒杀API之web层</a></li><li><a href="/note/note4.md">(四)Java高并发秒杀API之高并发优化</a>  </li></ul><p>这里按照上面几个流程走下去,你要有基本的Maven认识以及Java语法的一些概念,要不然可能不太理解</p><h3 id="一-Java高并发秒杀APi之业务分析与DAO层代码编写"><a href="#一-Java高并发秒杀APi之业务分析与DAO层代码编写" class="headerlink" title="(一)Java高并发秒杀APi之业务分析与DAO层代码编写"></a>(一)Java高并发秒杀APi之业务分析与DAO层代码编写</h3><h4 id="构建项目的基本骨架"><a href="#构建项目的基本骨架" class="headerlink" title="构建项目的基本骨架"></a>构建项目的基本骨架</h4><ul><li>首先我们要搭建出一个符合Maven约定的目录来,这里大致有两种方式,第一种:<ol><li>第一种使用命令行手动构建一个maven结构的目录,当然我基本不会这样构建<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate -DgroupId=com.suny.seckill -DartifactId=seckill -Dpackage=com.suny.seckill -Dversion=1.0-SNAPSHOT -DarchetypeArtifactId=maven-archetype-webapp</span><br><span class="line">```  </span><br><span class="line">这里要注意的是使用`archetype:generate`进行创建,在Maven老版本中是使用`archetype:create`,现在这种方法已经被弃用了,所以使用命令行创建的话注意了,稍微解释下这段语句的意思,就是构建一个一个`maven-archetype-webapp`骨架的Webapp项目,然后`groupId`为`com.suny.seckill `,`artifactId`为`seckill`,这里是Maven相关知识,可以按照自己的情况进行修改  </span><br><span class="line"></span><br><span class="line">2.第二种直接在IDE中进行创建,这里以IDEA为例</span><br><span class="line">  + 点击左上角`File&gt;New&gt;Project&gt;Maven`</span><br><span class="line">  + 然后在里面勾选`Create from archetype`,然后再往下拉找到`org.apache.cocoon:cocoon-22-archetype-webapp`,选中它,注意要先勾选那个选项,否则选择不了,然后点击`Next`继续  </span><br><span class="line">  ![创建Maven项目](images/001.png)    </span><br><span class="line">  +然后就填写你的Maven的那几个重要的坐标了,自己看着填吧  </span><br><span class="line">  ![填写Maven坐标](images/002.png)  </span><br><span class="line">  +再就配置你的Maven的相关信息,默认应该是配置好的  </span><br><span class="line">  ![填写Maven在你本机的位置](images/003.png)  </span><br><span class="line">  +之后就是点`Finsh`,到此不出意外的话就应该创建成功了    </span><br><span class="line"></span><br><span class="line">#### 构建pom文件</span><br><span class="line"></span><br><span class="line">  项目基本的骨架我们就创建出来了,接下来我们要添加一些基本的JAR包的依赖,也就是在`pom.xml`中添加各种开源组件的三坐标了    </span><br><span class="line"></span><br><span class="line">  ```xml</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;</span><br><span class="line">          &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">          &lt;groupId&gt;com.suny.seckill&lt;/groupId&gt;</span><br><span class="line">          &lt;artifactId&gt;seckill&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">          &lt;name&gt;seckill Maven Webapp&lt;/name&gt;</span><br><span class="line">          &lt;url&gt;http://maven.apache.org&lt;/url&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--junit测试--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.12&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--配置日志相关,日志门面使用slf4j,日志的具体实现由logback实现--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.7&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.7.21&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.6.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--数据库相关依赖--&gt;</span><br><span class="line">        &lt;!--首先导入连接Mysql数据连接--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.39&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--导入数据库连接池--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;c3p0&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;c3p0&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;0.9.1.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--导入mybatis依赖--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.4.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.3.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--导入Servlet web相关的依赖--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;taglibs&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;standard&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;jstl&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--spring默认的json转换--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.8.5&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.1.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--导入spring相关依赖--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.3.6.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.3.6.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.3.6.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.3.7.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-tx&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.3.6.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.3.6.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.3.7.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--导入springTest--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.2.7.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;finalName&gt;seckill&lt;/finalName&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure></li></ol></li></ul><h4 id="建立数据库"><a href="#建立数据库" class="headerlink" title="建立数据库"></a>建立数据库</h4><p>在根目录下有一个<a href="sql">sql</a>文件夹里面有一个<a href="sql/seckill.sql">sql数据库脚本</a>,如果你不想自己手写的话就直接导入到你的数据库里面去吧,不过还是建议自己手写一遍加深印象</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 整个项目的数据库脚本</span></span><br><span class="line"><span class="comment">-- 开始创建一个数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> seckill;</span><br><span class="line"><span class="comment">-- 使用数据库</span></span><br><span class="line"><span class="keyword">USE</span> seckill;</span><br><span class="line"><span class="comment">-- 创建秒杀库存表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> seckill(</span><br><span class="line">  <span class="string">`seckill_id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'商品库存ID'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line">  <span class="string">`number`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'库存数量'</span>,</span><br><span class="line">  <span class="string">`start_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>() <span class="keyword">COMMENT</span> <span class="string">'秒杀开启的时间'</span>,</span><br><span class="line">  <span class="string">`end_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>() <span class="keyword">COMMENT</span> <span class="string">'秒杀结束的时间'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>() <span class="keyword">COMMENT</span> <span class="string">'创建的时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (seckill_id),</span><br><span class="line">  <span class="keyword">KEY</span> idx_start_time(start_time),</span><br><span class="line">  <span class="keyword">KEY</span> idx_end_time(end_time),</span><br><span class="line">  <span class="keyword">KEY</span> idx_create_time(create_time)</span><br><span class="line">)<span class="keyword">ENGINE</span> =<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1000</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'秒杀库存表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入初始化数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span></span><br><span class="line">  seckill(<span class="keyword">name</span>,<span class="built_in">number</span>,start_time,end_time)</span><br><span class="line"><span class="keyword">values</span></span><br><span class="line">  (<span class="string">'1000元秒杀iphone6'</span>,<span class="number">100</span>,<span class="string">'2016-5-22 00:00:00'</span>,<span class="string">'2016-5-23 00:00:00'</span>),</span><br><span class="line">  (<span class="string">'500元秒杀iPad2'</span>,<span class="number">200</span>,<span class="string">'2016-5-22 00:00:00'</span>,<span class="string">'2016-5-23 00:00:00'</span>),</span><br><span class="line">  (<span class="string">'300元秒杀小米4'</span>,<span class="number">300</span>,<span class="string">'2016-5-22 00:00:00'</span>,<span class="string">'2016-5-23 00:00:00'</span>),</span><br><span class="line">  (<span class="string">'200元秒杀红米note'</span>,<span class="number">400</span>,<span class="string">'2016-5-22 00:00:00'</span>,<span class="string">'2016-5-23 00:00:00'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 秒杀成功明细表</span></span><br><span class="line"><span class="comment">-- 用户登录相关信息</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> success_killed(</span><br><span class="line">  <span class="string">`seckill_id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'秒杀商品ID'</span>,</span><br><span class="line">  <span class="string">`user_phone`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户手机号'</span>,</span><br><span class="line">  <span class="string">`state`</span> TINYINT <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">-1</span> <span class="keyword">COMMENT</span> <span class="string">'状态标示:-1无效 0成功 1已付款'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (seckill_id,user_phone), <span class="comment">/*联合主键*/</span></span><br><span class="line">  <span class="keyword">KEY</span> idx_create_time(create_time)</span><br><span class="line">)<span class="keyword">ENGINE</span> =InnDB <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> =utf8 <span class="keyword">COMMENT</span> =<span class="string">'秒杀成功明细表'</span></span><br></pre></td></tr></table></figure><ul><li>在建立数据库的,如果按照我这里的数据库脚本建立的话应该是没问题的,但是我按照视频里面的数据库脚本建表的话发生了一个错误<br><img src="images/sqlError.png" alt="sql报错"><br>这个报错看起来比较的诡异,我仔细检查<code>sql</code>也没有错误,它总提示我<code>end_time</code>要有一个默认的值,可我记得我以前就不会这样,然后视频里面也没有执行错误,然后我感觉可能时<code>MySQL</code>版本的差异,我查看了下我数据库版本,在登录<code>Mysql</code>控制台后输入指令,在控制台的我暂时知道的有两种方式:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">version</span>();  </span><br><span class="line"><span class="keyword">select</span> @@<span class="keyword">version</span>;</span><br></pre></td></tr></table></figure></li></ul><p>我的输出结果如下:<br><img src="images/mysqlVersion.png" alt="Mysql版本"><br>其实登录进控制台就已经可以看到版本了,我的Mysql是<code>5.7</code>的,以前我用的时<code>5.6</code>的,然后去<code>Google</code>上搜索了下,找到了几个答案,参考链接：  </p><ul><li><a href="https://stackoverflow.com/questions/9192027/invalid-default-value-for-create-date-timestamp-field" target="_blank" rel="noopener">Invalid default value for ‘create_date’ timestamp field</a>  <ul><li><a href="https://dev.mysql.com/doc/refman/5.7/en/sql-mode.html#sqlmode_no_zero_date" target="_blank" rel="noopener">mysql官方的解释</a>  </li><li><a href="https://stackoverflow.com/questions/34570611/mysql-community-5-7-invalid-default-value-datetime-field-type" target="_blank" rel="noopener">MySQL Community 5.7 - Invalid default value (datetime field type)</a><br>总结出来一句话就是:<blockquote><p>mysql 5.7中,默认使用的是严格模式,这里的日期必须要有时间,所以一定要给出默认值,要么就修改数据库设置  </p></blockquote></li></ul></li></ul><p>然后网友评论里总结出来的几种解决办法,未经测试！：  </p><ul><li><p>下次有问题一定要先看一下评论！！！create不了的同学,可以这样写：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`start_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP <span class="keyword">COMMENT</span> <span class="string">'秒杀开始时间'</span>,</span><br><span class="line"><span class="string">`end_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'秒杀结束时间'</span>,</span><br><span class="line"><span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br></pre></td></tr></table></figure><ul><li>关于timestamp的问题,需要先运行 set explicit_defaults_for_timestamp = 1,否则会报invalid default value错误</li><li>还需要注意的是SQL版本的问题会导致视频中seckill表创建会出错。只要将create_time放在start_time和end_time之前是方便的解决方法。  </li></ul><p>对比下我修改过后的跟视频里面的<code>sql</code>片段:<br><img src="images/sqlCompare.png" alt="sql对比"><br>我们可以看到在这三个字段有一个小差别,那就是给<code>start_time</code>,<code>end_time</code>,<code>create_time</code>三个字段都添加一个默认值,然后执行数据库语句就没问题了</p></li></ul><hr><h4 id="这里我们需要修改下web-xml中的servlet版本为3-0"><a href="#这里我们需要修改下web-xml中的servlet版本为3-0" class="headerlink" title="这里我们需要修改下web.xml中的servlet版本为3.0"></a>这里我们需要修改下<code>web.xml</code>中的servlet版本为<code>3.0</code></h4><p>打开<code>WEB-INF</code>下的<code>web.xml</code>,修改为以下代码:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"3.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">metadata-complete</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--用maven创建的web-app需要修改servlet的版本为3.0--&gt;</span></span><br></pre></td></tr></table></figure></p><p>修改的原因有以下几点:  </p><ul><li>高版本的Servlet支持更多的特性,更方便我们的Coding,特别是支持注解这一特性</li><li>在<code>Servlet2.3</code>中新加入了<code>Listener</code>接口的实现,,我们可以使用<code>Listener</code>引入<code>Spring</code>的<code>ContextLoaderListener</code>  </li></ul><p>举个栗子:  </p><ul><li><p>在<code>Servlet2.3</code>以前我们这样配置<code>ContextLoaderListener</code>:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>context<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.context.ContextLoaderServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在<code>Servlet2.3</code>以后可以使用<code>Listener</code>配置,也就是我们项目中使用的方法<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><p>两种方法的效果都是一样的,主要不要同时使用,否则会报错的  </p><h4 id="建立实体类"><a href="#建立实体类" class="headerlink" title="建立实体类"></a>建立实体类</h4><ul><li>首先建立<code>SuccessKilled</code>  秒杀状态表</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.suny.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuccessKilled</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1834437127882846202L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line">    <span class="comment">/* 用户的手机号码*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userPhone;</span><br><span class="line">    <span class="comment">/* 秒杀的状态*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">short</span> state;</span><br><span class="line">    <span class="comment">/* 创建时间*/</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="comment">/* 多对一,因为一件商品在库存中肯定有许多,对应的购买信息也有很多*/</span></span><br><span class="line">    <span class="keyword">private</span> Seckill seckill;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SuccessKilled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SuccessKilled</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, <span class="keyword">short</span> state, LocalDateTime createTime, Seckill seckill)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.userPhone = userPhone;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">        <span class="keyword">this</span>.seckill = seckill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getUserPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserPhone</span><span class="params">(<span class="keyword">long</span> userPhone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userPhone = userPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">short</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(LocalDateTime createTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getSeckill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckill</span><span class="params">(Seckill seckill)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckill = seckill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SuccessKilled&#123;"</span> +</span><br><span class="line">                <span class="string">"主键ID="</span> + seckillId +</span><br><span class="line">                <span class="string">", 手机号码="</span> + userPhone +</span><br><span class="line">                <span class="string">", 秒杀状态="</span> + state +</span><br><span class="line">                <span class="string">", 创建时间="</span> + createTime +</span><br><span class="line">                <span class="string">", 秒杀的商品="</span> + seckill +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>再建立<code>Seckill</code> 秒杀商品信息</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.suny.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Seckill</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2912164127598660137L</span>;</span><br><span class="line">    <span class="comment">/* 主键ID*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line">    <span class="comment">/*  秒杀商品名字 */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/* 秒杀的商品编号 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line">    <span class="comment">/* 开始秒杀的时间 */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime startTime;</span><br><span class="line">    <span class="comment">/* 结束秒杀的时间 */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime endTime;</span><br><span class="line">    <span class="comment">/* 创建的时间 */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTIme;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Seckill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Seckill</span><span class="params">(<span class="keyword">long</span> seckillId, String name, <span class="keyword">int</span> number, LocalDateTime startTime, LocalDateTime endTime, LocalDateTime createTIme)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">        <span class="keyword">this</span>.startTime = startTime;</span><br><span class="line">        <span class="keyword">this</span>.endTime = endTime;</span><br><span class="line">        <span class="keyword">this</span>.createTIme = createTIme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getStartTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStartTime</span><span class="params">(LocalDateTime startTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startTime = startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getEndTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEndTime</span><span class="params">(LocalDateTime endTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.endTime = endTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getCreateTIme</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTIme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTIme</span><span class="params">(LocalDateTime createTIme)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTIme = createTIme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"com.suny.entity.Seckill&#123;"</span> +</span><br><span class="line">                <span class="string">"主键ID="</span> + seckillId +</span><br><span class="line">                <span class="string">", 秒杀商品='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", 编号="</span> + number +</span><br><span class="line">                <span class="string">", 开始秒杀时间="</span> + startTime +</span><br><span class="line">                <span class="string">", 结束秒杀时间="</span> + endTime +</span><br><span class="line">                <span class="string">", 创建时间="</span> + createTIme +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="对实体类创建对应的mapper接口-也就是dao接口类"><a href="#对实体类创建对应的mapper接口-也就是dao接口类" class="headerlink" title="对实体类创建对应的mapper接口,也就是dao接口类"></a>对实体类创建对应的<code>mapper</code>接口,也就是<code>dao</code>接口类</h4><ul><li>首先创建<code>SeckillMapper</code>,在我这里位于<code>com.suny.dao</code>包下</li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.suny.dao;</span><br><span class="line"><span class="keyword">import</span> com.suny.entity.Seckill;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillMapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据传过来的&lt;code&gt;seckillId&lt;/code&gt;去减少商品的库存.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀商品ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> killTime  秒杀的精确时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果秒杀成功就返回1,否则就返回0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">reduceNumber</span><span class="params">(@Param(<span class="string">"seckillId"</span>)</span> <span class="keyword">long</span> seckillId, @<span class="title">Param</span><span class="params">(<span class="string">"killTime"</span>)</span> LocalDateTime killTime)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据传过来的&lt;code&gt;seckillId&lt;/code&gt;去查询秒杀商品的详情.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀商品ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 对应商品ID的的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Seckill <span class="title">queryById</span><span class="params">(@Param(<span class="string">"seckillId"</span>)</span> <span class="keyword">long</span> seckillId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据一个偏移量去查询秒杀的商品列表.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> offset 偏移量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> limit  限制查询的数据个数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 符合偏移量查出来的数据个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Seckill&gt; <span class="title">queryAll</span><span class="params">(@Param(<span class="string">"offset"</span>)</span> <span class="keyword">int</span> offset, @<span class="title">Param</span><span class="params">(<span class="string">"limit"</span>)</span> <span class="keyword">int</span> limit)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>再创建<code>SuccessKilledMapper</code></li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.suny.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.suny.entity.SuccessKilled;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SuccessKilledMapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入一条详细的购买信息.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀商品的ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone 购买用户的手机号码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功插入就返回1, 否则就返回0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertSuccessKilled</span><span class="params">(@Param(<span class="string">"seckillId"</span>)</span> <span class="keyword">long</span> seckillId, @<span class="title">Param</span><span class="params">(<span class="string">"userPhone"</span>)</span> <span class="keyword">long</span> userPhone)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据秒杀商品的ID查询&lt;code&gt;SuccessKilled&lt;/code&gt;的明细信息.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀商品的ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone 购买用户的手机号码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 秒杀商品的明细信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SuccessKilled <span class="title">queryByIdWithSeckill</span><span class="params">(@Param(<span class="string">"seckillId"</span>)</span> <span class="keyword">long</span> seckillId, @<span class="title">Param</span><span class="params">(<span class="string">"userPhone"</span>)</span> <span class="keyword">long</span> userPhone)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="接下来书写xml配置文件"><a href="#接下来书写xml配置文件" class="headerlink" title="接下来书写xml配置文件"></a>接下来书写<code>xml</code>配置文件</h4><h5 id="建立对应的mapper-xml"><a href="#建立对应的mapper-xml" class="headerlink" title="建立对应的mapper.xml"></a>建立对应的<code>mapper.xml</code></h5><p>首先在<code>src/main/resources</code>建立<code>com.suny.dao</code>这个包,也就是对应<code>mapper</code>接口文件包一样的包名,这样符合Maven的约定,就是资源放置在<code>Resource</code>包下,<code>Java</code>包下则是放置<code>java</code>类文件,编译后最后还是会在同一个目录下.<br><img src="images/004.png" alt="建包"></p><ul><li>首先建立<code>SeckillMapper.xml</code></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE mapper</span></span><br><span class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.suny.dao.SeckillMapper"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这里的&lt;=需要使用进行忽略,所以是要进行忽略,使用CDATA 区段中的文本会被解析器忽略 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"reduceNumber"</span>&gt;</span></span><br><span class="line">        UPDATE seckill</span><br><span class="line">        SET number = number - 1</span><br><span class="line">        WHERE seckill_id = #&#123;seckillId&#125;</span><br><span class="line">              AND start_time</span><br><span class="line">              &lt;![CDATA[</span><br><span class="line">              &lt;=</span><br><span class="line">              ]]&gt;</span><br><span class="line">         #&#123;killTime&#125;</span><br><span class="line">              AND end_time &gt;= #&#123;killTime&#125;</span><br><span class="line">              AND number &gt; 0</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryById"</span> <span class="attr">resultType</span>=<span class="string">"com.suny.entity.Seckill"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            *</span><br><span class="line">        FROM seckill AS s</span><br><span class="line">        WHERE s.seckill_id = #&#123;seckillId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryAll"</span> <span class="attr">resultType</span>=<span class="string">"com.suny.entity.Seckill"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            *</span><br><span class="line">        FROM seckill AS s</span><br><span class="line">        ORDER BY create_time DESC</span><br><span class="line">        LIMIT #&#123;offset&#125;, #&#123;limit&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>建立<code>SuccessKilledMapper.xml</code></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper</span></span><br><span class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.suny.dao.SuccessKilledMapper"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--添加主键冲突时忽略错误返回0--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertSuccessKilled"</span>&gt;</span></span><br><span class="line">        INSERT IGNORE INTO success_killed (seckill_id, user_phone, state)</span><br><span class="line">        VALUES (#&#123;seckillId&#125;, #&#123;userPhone&#125;, 0)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--根据seckillId查询SuccessKilled对象,并携带Seckill对象,告诉mybatis把映射结果映射到SuccessKill属性同时映射到Seckill属性--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryByIdWithSeckill"</span> <span class="attr">resultType</span>=<span class="string">"com.suny.entity.SuccessKilled"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            sk.seckill_id,</span><br><span class="line">            sk.user_phone,</span><br><span class="line">            sk.create_time,</span><br><span class="line">            sk.state,</span><br><span class="line">            s.seckill_id  "seckill.seckill_id",</span><br><span class="line">            s.name "seckill.name",</span><br><span class="line">            s.number "seckill",</span><br><span class="line">            s.start_time  "seckill.start_time",</span><br><span class="line">            s.end_time  "seckill.end_time",</span><br><span class="line">            s.create_time "seckill.create_time"</span><br><span class="line">        FROM success_killed sk</span><br><span class="line">            INNER JOIN seckill s ON sk.seckill_id = s.seckill_id</span><br><span class="line">        WHERE sk.seckill_id = #&#123;seckillId&#125;</span><br><span class="line">              AND sk.user_phone= #&#123;userPhone&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p>建立<code>Mybatis</code>的配置文件<code>mybatis-config.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE configuration PUBLIC</span></span><br><span class="line"><span class="meta">        "-//mybatis.org//DTD MyBatis Generator Configuration 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-config.dtd" &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--首先配置全局属性--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--开启自动填充主键功能,原理时通过jdbc的一个方法getGeneratekeys获取自增主键值--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useGeneratedKeys"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--使用别名替换列名,默认就是开启的--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useColumnLabel"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--开启驼峰命名的转换--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>然后建立连接数据库的配置文件<code>jdbc.properties</code>,这里的属性要根据自己的需要去进行修改,切勿直接复制使用  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdbc.driver=com.mysql.jdbc.Driver</span><br><span class="line">jdbc.user=root</span><br><span class="line">jdbc.password=root</span><br><span class="line">jdbc.url=jdbc:mysql://localhost:3306/seckill?useUnicode=true&amp;characterEncoding=utf-8</span><br></pre></td></tr></table></figure></li><li><p>建立<code>Spring</code>的<code>dao</code>的配置文件,在<code>resources</code>包下创建<code>applicationContext-dao.xml</code></p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--suppress SpringFacetInspection --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:jdbc.properties"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置数据库连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置基本的数据库连接--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driver&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.user&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--c3p0私有属性--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolSize"</span> <span class="attr">value</span>=<span class="string">"30"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minPoolSize"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--关闭连接后不自动commit--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"autoCommitOnClose"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--获取连接超时时间--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"checkoutTimeout"</span> <span class="attr">value</span>=<span class="string">"1000"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--当获取连接失败时的重试次数--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置sqlSessionFactory对象--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--注入数据库连接池--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置mybatis全局配置文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"mybatis-config.xml"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置entity包,也就是实体类包,自动扫描,用于别名配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"typeAliasesPackage"</span> <span class="attr">value</span>=<span class="string">"com.suny.entity"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置需要扫描的mapper.xml文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapperLocations"</span> <span class="attr">value</span>=<span class="string">"classpath*:com/suny/dao/*.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置mapper接口包,动态实现mapper接口,注入到Spring容器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--注入sqlSessionFactory,请注意不要使用sqlSessionFactoryBean,否则会出现注入异常--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sqlSessionFactoryBeanName"</span> <span class="attr">value</span>=<span class="string">"sqlSessionFactory"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--给出要扫描的mapper接口--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basePackage"</span> <span class="attr">value</span>=<span class="string">"com.suny.dao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>基础的部分我们搭建完成了,然后要开始测试了<br>在<code>IDEA</code>里面有一个快速建立测试的快捷键<code>Ctrl+Shift+T</code>,在某个要测试的类里面按下这个快捷键就会出现<code>Create new Test</code>,然后选择你要测试的方法跟测试的工具就可以了,这里我们使用Junit作为测试<ul><li>建立<code>SeckillMapperTest</code>文件,代码如下</li></ul></li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.suny.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.suny.entity.Seckill;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(&#123;<span class="string">"classpath:spring/applicationContext-dao.xml"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillMapperTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SeckillMapper seckillMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceNumber</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId=<span class="number">1000</span>;</span><br><span class="line">        LocalDateTime localDateTime=LocalDateTime.now();</span><br><span class="line">        <span class="keyword">int</span> i = seckillMapper.reduceNumber(seckillId, localDateTime);</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId = <span class="number">1000</span>;</span><br><span class="line">        Seckill seckill = seckillMapper.queryById(seckillId);</span><br><span class="line">        System.out.println(seckill.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;Seckill&gt; seckills = seckillMapper.queryAll(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">for</span> (Seckill seckill : seckills) &#123;</span><br><span class="line">            System.out.println(seckill.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试中可能会出现<code>Mybatis</code>参数绑定失败的错误,在<code>mapper</code>接口中的方法里面添加<code>@Param</code>的注解,显示的告诉mybatis参数的名称是什么,例如<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function">List&lt;Seckill&gt; <span class="title">queryAll</span><span class="params">(@Param(<span class="string">"offset"</span>)</span> <span class="keyword">int</span> offset, @<span class="title">Param</span><span class="params">(<span class="string">"limit"</span>)</span> <span class="keyword">int</span> limit)</span>;</span><br><span class="line"></span><br><span class="line">```  </span><br><span class="line">#### 2016-5-23 13:46：28</span><br><span class="line"></span><br><span class="line">---   </span><br><span class="line"></span><br><span class="line">### (二)Java高并发秒杀API之Service层</span><br><span class="line"> 首先在编写`Service`层代码前,我们应该首先要知道这一层到底时干什么的,这里摘取来自`ITEYE`一位博主的原话</span><br><span class="line"> &gt; Service层主要负责业务模块的逻辑应用设计。同样是首先设计接口,再设计其实现的类,接着再Spring的配置文件中配置其实现的关联。这样我们就可以在应用中调用Service接口来进行业务处理。Service层的业务实现,具体要调用到已定义的DAO层的接口,封装Service层的业务逻辑有利于通用的业务逻辑的独立性和重复利用性,程序显得非常简洁。  </span><br><span class="line"></span><br><span class="line"> 在项目中要降低耦合的话,分层是一种很好的概念,就是各层各司其职,尽量不做不相干的事,所以`Service`层的话顾名思义就是**业务逻辑**,处理程序中的一些业务逻辑,以及调用`DAO`层的代码,这里我们的`DAo`层就是连接数据库的那一层,调用关系可以这样表达:  </span><br><span class="line">   View(页面)&gt;Controller(控制层)&gt;Service(业务逻辑)&gt;Dao(数据访问)&gt;Database(数据库)  </span><br><span class="line">   + 首先还是接口的设计,设计Service秒杀商品的接口  ``SeckillService``</span><br><span class="line">  首先在`som.suny`包下建立`interfaces`这个包,这个包里面存放`Service`相关的接口,然后建立`SeckillService`接口文件,代码如下:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ```java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  查询全部的秒杀记录.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据库中所有的秒杀记录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Seckill&gt; <span class="title">getSeckillList</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *   查询单个秒杀记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId   秒杀记录的ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>   根据ID查询出来的记录信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Seckill <span class="title">getById</span><span class="params">(<span class="keyword">long</span> seckillId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在秒杀开启时输出秒杀接口的地址,否则输出系统时间跟秒杀地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId  秒杀商品Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  根据对应的状态返回对应的状态实体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行秒杀操作,有可能是失败的,失败我们就抛出异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId  秒杀的商品ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone 手机号码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> md5   md5加密值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>   根据不同的结果返回不同的实体信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId,<span class="keyword">long</span> userPhone,String md5)</span><span class="keyword">throws</span> SeckillException,RepeatKillException,SeckillCloseException</span>;</span><br></pre></td></tr></table></figure></p><p>建立后接口之后我们要写实现类了,在写实现类的时候我们肯定会碰到一个这样的问题,你要向前端返回<code>json</code>数据的话,你是返回什么样的数据好?直接返回一个数字状态码或者时文字?这样设计肯定是不好的,所以我们应该向前段返回一个实体信息<code>json</code>,里面包含了一系列的信息,无论是哪种状态都应该可以应对,既然是与数据库字段无关的类,那就不是<code>PO</code>了,所以我们建立一个<code>DTO</code>数据传输类,关于常见的几种对象我的解释如下:</p><ul><li>PO:   也就是我们在为每一张数据库表写一个实体的类</li><li>VO,   对某个页面或者展现层所需要的数据,封装成一个实体类</li><li>BO,   就是业务对象,我也不是很了解</li><li>DTO,  跟VO的概念有点混淆,也是相当于页面需要的数据封装成一个实体类</li><li><p>POJO, 简单的无规则java对象</p><p>在<code>com.suny</code>下建立<code>dto</code>包,然后建立<code>Exposer</code>类,这个类是秒杀时数据库那边处理的结果的对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exposer</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*是否开启秒杀 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> exposed;</span><br><span class="line">    <span class="comment">/*  对秒杀地址进行加密措施  */</span></span><br><span class="line">    <span class="keyword">private</span> String md5;</span><br><span class="line">    <span class="comment">/* id为seckillId的商品秒杀地址   */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line">    <span class="comment">/* 系统当前的时间   */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime now;</span><br><span class="line">    <span class="comment">/* 秒杀开启的时间   */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime start;</span><br><span class="line">    <span class="comment">/*  秒杀结束的时间  */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, String md5, <span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.md5 = md5;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, <span class="keyword">long</span> seckillId, LocalDateTime now, LocalDateTime start, LocalDateTime end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.now = now;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exposer</span><span class="params">(<span class="keyword">boolean</span> exposed, <span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExposed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exposed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExposed</span><span class="params">(<span class="keyword">boolean</span> exposed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exposed = exposed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMd5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMd5</span><span class="params">(String md5)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.md5 = md5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNow</span><span class="params">(LocalDateTime now)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.now = now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStart</span><span class="params">(LocalDateTime start)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnd</span><span class="params">(LocalDateTime end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Exposer&#123;"</span> +</span><br><span class="line">                <span class="string">"秒杀状态="</span> + exposed +</span><br><span class="line">                <span class="string">", md5加密值='"</span> + md5 + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", 秒杀ID="</span> + seckillId +</span><br><span class="line">                <span class="string">", 当前时间="</span> + now +</span><br><span class="line">                <span class="string">", 开始时间="</span> + start +</span><br><span class="line">                <span class="string">", 结束="</span> + end +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>然后我们给页面返回的数据应该是更加友好的封装数据,所以我们再在<code>com.suny.dto</code>包下再建立<code>SeckillExecution</code>用来封装给页面的结果:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillExecution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> seckillId;</span><br><span class="line">    <span class="comment">/* 执行秒杀结果的状态   */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line">    <span class="comment">/* 状态的明文标示   */</span></span><br><span class="line">    <span class="keyword">private</span> String stateInfo;</span><br><span class="line">    <span class="comment">/*  当秒杀成功时,需要传递秒杀结果的对象回去  */</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilled successKilled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  秒杀成功返回的实体  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">int</span> state, String stateInfo, SuccessKilled successKilled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">        <span class="keyword">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  秒杀失败返回的实体  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">int</span> state, String stateInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSeckillId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeckillId</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStateInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStateInfo</span><span class="params">(String stateInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = stateInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SuccessKilled <span class="title">getSuccessKilled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccessKilled</span><span class="params">(SuccessKilled successKilled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SeckillExecution&#123;"</span> +</span><br><span class="line">                <span class="string">"秒杀的商品ID="</span> + seckillId +</span><br><span class="line">                <span class="string">", 秒杀状态="</span> + state +</span><br><span class="line">                <span class="string">", 秒杀状态信息='"</span> + stateInfo + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", 秒杀的商品="</span> + successKilled +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="定义秒杀中可能会出现的异常"><a href="#定义秒杀中可能会出现的异常" class="headerlink" title="定义秒杀中可能会出现的异常"></a>定义秒杀中可能会出现的异常</h5><ul><li><p>定义一个基础的异常,所有的子异常继承这个异常<code>SeckillException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  秒杀基础异常</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-23.下午8:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>首选可能会出现秒杀关闭后被秒杀情况,所以建立秒杀关闭异常<code>SeckillCloseException</code>,需要继承我们一开始写的基础异常</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 秒杀已经关闭异常,当秒杀结束就会出现这个异常</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-23.下午8:27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillCloseException</span> <span class="keyword">extends</span> <span class="title">SeckillException</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillCloseException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillCloseException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>然后还有可能发生重复秒杀异常<code>RepeatKillException</code></li></ul>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重复秒杀异常,不需要我们手动去try catch</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-23.下午8:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatKillException</span> <span class="keyword">extends</span> <span class="title">SeckillException</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepeatKillException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepeatKillException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现Service接口"><a href="#实现Service接口" class="headerlink" title="实现Service接口"></a>实现<code>Service</code>接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-23.下午9:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceImpl</span> <span class="keyword">implements</span> <span class="title">SeckillService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="comment">/* 加入一个盐值,用于混淆*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String salt = <span class="string">"thisIsASaltValue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillMapper seckillMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SuccessKilledMapper successKilledMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询全部的秒杀记录.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据库中所有的秒杀记录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Seckill&gt; <span class="title">getSeckillList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillMapper.queryAll(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询单个秒杀记录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀记录的ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 根据ID查询出来的记录信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getById</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seckillMapper.queryById(seckillId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在秒杀开启时输出秒杀接口的地址,否则输出系统时间跟秒杀地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀商品Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 根据对应的状态返回对应的状态实体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据秒杀的ID去查询是否存在这个商品</span></span><br><span class="line">       <span class="comment">/* Seckill seckill = seckillMapper.queryById(seckillId);</span></span><br><span class="line"><span class="comment">        if (seckill == null) &#123;</span></span><br><span class="line"><span class="comment">            logger.warn("查询不到这个秒杀产品的记录");</span></span><br><span class="line"><span class="comment">            return new Exposer(false, seckillId);</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">        Seckill seckill = redisDao.getSeckill(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 访问数据库读取数据</span></span><br><span class="line">            seckill = seckillMapper.queryById(seckillId);</span><br><span class="line">            <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 放入redis</span></span><br><span class="line">                redisDao.putSeckill(seckill);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否还没到秒杀时间或者是过了秒杀时间</span></span><br><span class="line">        LocalDateTime startTime = seckill.getStartTime();</span><br><span class="line">        LocalDateTime endTime = seckill.getEndTime();</span><br><span class="line">        LocalDateTime nowTime = LocalDateTime.now();</span><br><span class="line">        <span class="comment">//   开始时间大于现在的时候说明没有开始秒杀活动    秒杀活动结束时间小于现在的时间说明秒杀已经结束了</span></span><br><span class="line">       <span class="comment">/* if (!nowTime.isAfter(startTime)) &#123;</span></span><br><span class="line"><span class="comment">            logger.info("现在的时间不在开始时间后面,未开启秒杀");</span></span><br><span class="line"><span class="comment">            return new Exposer(false, seckillId, nowTime, startTime, endTime);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        if (!nowTime.isBefore(endTime)) &#123;</span></span><br><span class="line"><span class="comment">            logger.info("现在的时间不在结束的时间之前,可以进行秒杀");</span></span><br><span class="line"><span class="comment">            return new Exposer(false, seckillId, nowTime, startTime, endTime);</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">        <span class="keyword">if</span> (nowTime.isAfter(startTime) &amp;&amp; nowTime.isBefore(endTime)) &#123;</span><br><span class="line">            <span class="comment">//秒杀开启,返回秒杀商品的id,用给接口加密的md5</span></span><br><span class="line">            String md5 = getMd5(seckillId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">true</span>, md5, seckillId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId, nowTime, startTime, endTime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getMd5</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        String base = seckillId + <span class="string">"/"</span> + salt;</span><br><span class="line">        <span class="keyword">return</span> DigestUtils.md5DigestAsHex(base.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行秒杀操作,失败的,失败我们就抛出异常</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀的商品ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone 手机号码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> md5       md5加密值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 根据不同的结果返回不同的实体信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> <span class="keyword">throws</span> SeckillException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (md5 == <span class="keyword">null</span> || !md5.equals(getMd5(seckillId))) &#123;</span><br><span class="line">            logger.error(<span class="string">"秒杀数据被篡改"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">"seckill data rewrite"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行秒杀业务逻辑</span></span><br><span class="line">        LocalDateTime nowTIme = LocalDateTime.now();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行减库存操作</span></span><br><span class="line">            <span class="keyword">int</span> reduceNumber = seckillMapper.reduceNumber(seckillId, nowTIme);</span><br><span class="line">            <span class="keyword">if</span> (reduceNumber &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                logger.warn(<span class="string">"没有更新数据库记录,说明秒杀结束"</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SeckillCloseException(<span class="string">"seckill is closed"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 这里至少减少的数量不为0了,秒杀成功了就增加一个秒杀成功详细</span></span><br><span class="line">                <span class="keyword">int</span> insertCount = successKilledMapper.insertSuccessKilled(seckillId, userPhone);</span><br><span class="line">                <span class="comment">// 查看是否被重复插入,即用户是否重复秒杀</span></span><br><span class="line">                <span class="keyword">if</span> (insertCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RepeatKillException(<span class="string">"seckill repeated"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 秒杀成功了,返回那条插入成功秒杀的信息</span></span><br><span class="line">                    SuccessKilled successKilled = successKilledMapper.queryByIdWithSeckill(seckillId, userPhone);</span><br><span class="line"><span class="comment">//                    return new SeckillExecution(seckillId,1,"秒杀成功");</span></span><br><span class="line">                      <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId,<span class="number">1</span>,<span class="string">"秒杀成功"</span>,successKilled);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SeckillCloseException | RepeatKillException e1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e1;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">            <span class="comment">// 把编译期异常转换为运行时异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">"seckill inner error : "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>在这里我们捕获了运行时异常,这样做的原因就是<code>Spring</code>的事物默认就是发生了<code>RuntimeException</code>才会回滚,可以检测出来的异常是不会导致事物的回滚的,这样的目的就是你明知道这里会发生异常,所以你一定要进行处理.如果只是为了让编译通过的话,那捕获异常也没多意思,所以这里要注意事物的回滚.<br>然后我们还发现这里存在硬编码的现象,就是返回各种字符常量,例如<code>秒杀成功</code>,<code>秒杀失败</code>等等,这些字符串时可以被重复使用的,而且这样维护起来也不方便,要到处去类里面寻找这样的字符串,所有我们使用枚举类来管理这样状态,在<code>con.suny</code>包下建立<code>enum</code>包,专门放置枚举类,然后再建立<code>SeckillStatEnum</code>枚举类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 常量枚举类</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-23.下午10:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SeckillStatEnum &#123;</span><br><span class="line">    SUCCESS(<span class="number">1</span>, <span class="string">"秒杀成功"</span>),</span><br><span class="line">    END(<span class="number">0</span>, <span class="string">"秒杀结束"</span>),</span><br><span class="line">    REPEAT_KILL(-<span class="number">1</span>, <span class="string">"重复秒杀"</span>),</span><br><span class="line">    INNER_ERROR(-<span class="number">2</span>, <span class="string">"系统异常"</span>),</span><br><span class="line">    DATE_REWRITE(-<span class="number">3</span>, <span class="string">"数据篡改"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    SeckillStatEnum() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SeckillStatEnum(<span class="keyword">int</span> state, String info) &#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        <span class="keyword">this</span>.info = info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SeckillStatEnum <span class="title">stateOf</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (SeckillStatEnum statEnum : values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (statEnum.getState() == index) &#123;</span><br><span class="line">                <span class="keyword">return</span> statEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>既然把这些改成了枚举,那么在<code>SeckillServiceImpl</code>类中的<code>executeSeckill</code>方法中成功秒杀的返回值就应该修改为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, successKilled);</span><br></pre></td></tr></table></figure></p><p>改了这里以后会发现会报错,因为在实体类那边构造函数可不是这样的,然后修改<code>SeckillExecution</code>类的构造函数,把<code>state</code>跟<code>stateInfo</code>的值设置从构造函数里面的<code>SeckillStatEnum</code>中取出值来设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*  秒杀成功返回的实体  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, SeckillStatEnum statEnum, SuccessKilled successKilled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.state = statEnum.getState();</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = statEnum.getInfo();</span><br><span class="line">        <span class="keyword">this</span>.successKilled = successKilled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  秒杀失败返回的实体  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillExecution</span><span class="params">(<span class="keyword">long</span> seckillId, SeckillStatEnum statEnum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillId = seckillId;</span><br><span class="line">        <span class="keyword">this</span>.state = statEnum.getState();</span><br><span class="line">        <span class="keyword">this</span>.stateInfo = statEnum.getInfo();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><h4 id="下一步肯定要注入Service了"><a href="#下一步肯定要注入Service了" class="headerlink" title="下一步肯定要注入Service了"></a>下一步肯定要注入Service了</h4><p>首先在<code>resources/spring</code>下建立<code>applicationContext-service.xml</code>文件,用来配置<code>Service层的相关代码</code>:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置自动扫描service包下的注解,在这里配置了自动扫描后,com.suny.service包下所有带有@Service注解的类都会被加入Spring容器中--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.suny.service"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置事物,这里时使用基于注解的事物--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--注入数据库连接池--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--开启基于注解的申明式事物--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在这里开启了基于<strong>注解</strong>的事物,常见的事物操作有以下几种方法</p><ul><li>在Spring早期版本中是使用ProxyFactoryBean+XMl方式来配置事物.</li><li>在Spring配置文件使用tx:advice+aop命名空间,好处就是一次配置永久生效,你无须去关心中间出的问题,不过出错了你很难找出来在哪里出了问题</li><li>注解@Transactional的方式,注解可以在<code>方法定义</code>,<code>接口定义</code>,<code>类定义</code>,<code>public方法上</code>,但是不能注解在<code>private</code>,<code>final</code>,<code>static</code>等方法上,因为Spring的事物管理默认是使用Cglib动态代理的:<ul><li>private方法因为访问权限限制,无法被子类覆盖</li><li>final方法无法被子类覆盖</li><li>static时类级别的方法,无法被子类覆盖</li><li>protected方法可以被子类覆盖,因此可以被动态字节码增强<h5 id="不能被Spring-AOP事物增强的方法"><a href="#不能被Spring-AOP事物增强的方法" class="headerlink" title="不能被Spring AOP事物增强的方法"></a>不能被Spring AOP事物增强的方法</h5>| 序号 | 动态代理策略 |不能被事物增强的方法 |<br>|:—–:| :—–: |:—–:|<br>|  1    |基于接口的动态代理  |出了public以外的所有方法,并且 public static 的方法也不能被增强 |<br>|   2   |基于Cglib的动态代理  | private,static,final的方法 |</li></ul></li></ul><p>然后你要在<code>Service</code>类上添加注解<code>@Service</code>,不用在接口上添加注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceImpl</span> <span class="keyword">implements</span> <span class="title">SeckillService</span></span></span><br></pre></td></tr></table></figure></p><p>既然已经开启了基于注解的事物,那我们就去需要被事物的方法上加个注解<code>@Transactional</code>吧:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> <span class="keyword">throws</span> SeckillException</span></span><br></pre></td></tr></table></figure></p><h4 id="Service层的测试"><a href="#Service层的测试" class="headerlink" title="Service层的测试"></a>Service层的测试</h4><p>写测试类,我这里的测试类名为<code>SeckillServiceImplTest</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-23.下午10:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(&#123;<span class="string">"classpath:spring/applicationContext-dao.xml"</span>, <span class="string">"classpath:spring/applicationContext-service.xml"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillService seckillService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSeckillList</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;Seckill&gt; seckillList = seckillService.getSeckillList();</span><br><span class="line">        logger.info(seckillList.toString());</span><br><span class="line">        System.out.println(seckillList.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId = <span class="number">1000</span>;</span><br><span class="line">        Seckill byId = seckillService.getById(seckillId);</span><br><span class="line">        System.out.println(byId.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exportSeckillUrl</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId = <span class="number">1000</span>;</span><br><span class="line">        Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">        System.out.println(exposer.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeSeckill</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId = <span class="number">1000</span>;</span><br><span class="line">        Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (exposer.isExposed()) &#123;</span><br><span class="line">            <span class="keyword">long</span> userPhone = <span class="number">12222222222L</span>;</span><br><span class="line">            String md5 = <span class="string">"bf204e2683e7452aa7db1a50b5713bae"</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                SeckillExecution seckillExecution = seckillService.executeSeckill(seckillId, userPhone, md5);</span><br><span class="line">                System.out.println(seckillExecution.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SeckillCloseException | RepeatKillException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"秒杀未开启"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeSeckillProcedureTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> seckillId = <span class="number">1001</span>;</span><br><span class="line">        <span class="keyword">long</span> phone = <span class="number">1368011101</span>;</span><br><span class="line">        Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (exposer.isExposed()) &#123;</span><br><span class="line">            String md5 = exposer.getMd5();</span><br><span class="line">            SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, phone, md5);</span><br><span class="line">            System.out.println(execution.getStateInfo());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试的话如果每个方法测试都通过就说明通过,如果报错了话就仔细看下哪一步错了检查下  </p><hr><h3 id="三-Java高并发秒杀系统API之Web层开发"><a href="#三-Java高并发秒杀系统API之Web层开发" class="headerlink" title="(三)Java高并发秒杀系统API之Web层开发"></a>(三)Java高并发秒杀系统API之Web层开发</h3><h4 id="既然是Web层的会肯定要先引入SpringMvc了"><a href="#既然是Web层的会肯定要先引入SpringMvc了" class="headerlink" title="既然是Web层的会肯定要先引入SpringMvc了"></a>既然是Web层的会肯定要先引入SpringMvc了</h4><ul><li>修改<code>web.xml</code>,引入<code>SpringMvc</code>的<code>DispatcherServlet</code>：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"3.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">metadata-complete</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--用maven创建的web-app需要修改servlet的版本为3.0--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>seckill-dispatchServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置springmvc的配置文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/applicationContext-*.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">            1</span><br><span class="line">        <span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>seckill-dispatchServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--直接拦截所有请求,不再采用spring2.0的/*或者*.do方式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>在这里的话如果你不配置这一段代码的：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置springmvc的配置文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/applicationContext-*.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>SpringMvc默认就会默认去<code>WEB-INF</code>下查找默认规范的配置文件,像我这里配置的<code>servlet-name</code>是<code>seckill-dispatchServlet</code>的话,则默认会寻找<code>WEB-INF</code>一个名为<code>seckill-dispatchServlet-Servlet.xml</code>的配置文件</p><h4 id="接下来编写Controller-SeckillController"><a href="#接下来编写Controller-SeckillController" class="headerlink" title="接下来编写Controller  SeckillController"></a>接下来编写Controller  <code>SeckillController</code></h4><p>首先在<code>com.suny</code>下建立包为<code>Controller</code>的包,然后在里面新建一个类<code>SeckillController</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.suny.controller;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-24.下午10:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/seckill"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SeckillService seckillService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillController</span><span class="params">(SeckillService seckillService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seckillService = seckillService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进入秒杀列表.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model 模型数据,里面放置有秒杀商品的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 秒杀列表详情页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = &#123;<span class="string">"/list"</span>,<span class="string">""</span>,<span class="string">"index"</span>&#125;, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">list</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        List&lt;Seckill&gt; seckillList = seckillService.getSeckillList();</span><br><span class="line">        model.addAttribute(<span class="string">"list"</span>, seckillList);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"list"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;seckillId&#125;/detail"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">detail</span><span class="params">(@PathVariable(<span class="string">"seckillId"</span>)</span> Long seckillId, Model model) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (seckillId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/seckill/list"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Seckill seckill = seckillService.getById(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"forward:/seckill/list"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">"seckill"</span>, seckill);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"detail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 暴露秒杀接口的方法.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀商品的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 根据用户秒杀的商品id进行业务逻辑判断,返回不同的json实体结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;seckillId&#125;/exposer"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;Exposer&gt; <span class="title">exposer</span><span class="params">(@PathVariable(<span class="string">"seckillId"</span>)</span> Long seckillId) </span>&#123;</span><br><span class="line">        <span class="comment">// 查询秒杀商品的结果</span></span><br><span class="line">        SeckillResult&lt;Exposer&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">            result = <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">true</span>, exposer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            result = <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户执行秒杀,在页面点击相应的秒杀连接,进入后获取对应的参数进行判断,返回相对应的json实体结果,前端再进行处理.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 秒杀的商品,对应的时秒杀的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> md5       一个被混淆的md5加密值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userPhone 参与秒杀用户的额手机号码,当做账号密码使用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 参与秒杀的结果,为json数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;seckillId&#125;/&#123;md5&#125;/execution"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;SeckillExecution&gt; <span class="title">execute</span><span class="params">(@PathVariable(<span class="string">"seckillId"</span>)</span> <span class="keyword">long</span> seckillId,</span></span><br><span class="line"><span class="function">                                                   @<span class="title">PathVariable</span><span class="params">(<span class="string">"md5"</span>)</span> String md5,</span></span><br><span class="line"><span class="function">                                                   @<span class="title">CookieValue</span><span class="params">(value = <span class="string">"userPhone"</span>, required = <span class="keyword">false</span>)</span> Long userPhone) </span>&#123;</span><br><span class="line">        <span class="comment">// 如果用户的手机号码为空的说明没有填写手机号码进行秒杀</span></span><br><span class="line">        <span class="keyword">if</span> (userPhone == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, <span class="string">"没有注册"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据用户的手机号码,秒杀商品的id跟md5进行秒杀商品,没异常就是秒杀成功</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 这里换成储存过程</span></span><br><span class="line"> SeckillExecution execution = seckillService.executeSeckill(seckillId, userPhone, md5);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">true</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RepeatKillException e1) &#123;</span><br><span class="line">            <span class="comment">// 重复秒杀</span></span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.REPEAT_KILL);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SeckillCloseException e2) &#123;</span><br><span class="line">            <span class="comment">// 秒杀关闭</span></span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.END);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SeckillException e) &#123;</span><br><span class="line">            <span class="comment">// 不能判断的异常</span></span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果有异常就是秒杀失败</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务器端时间,防止用户篡改客户端时间提前参与秒杀</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 时间的json数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/time/now"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;LocalDateTime&gt; <span class="title">time</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LocalDateTime localDateTime = LocalDateTime.now();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">true</span>, localDateTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="建立一个全局ajax请求返回类-返回json类型"><a href="#建立一个全局ajax请求返回类-返回json类型" class="headerlink" title="建立一个全局ajax请求返回类,返回json类型"></a>建立一个全局ajax请求返回类,返回json类型</h4><p><code>SeckillResult</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.suny.dto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装所有的ajax请求返回类型,方便返回json</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-24.下午10:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String error;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillResult</span><span class="params">(<span class="keyword">boolean</span> success, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SeckillResult</span><span class="params">(<span class="keyword">boolean</span> success, String error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccess</span><span class="params">(<span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(String error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.error = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SeckillResult&#123;"</span> +</span><br><span class="line">                <span class="string">"状态="</span> + success +</span><br><span class="line">                <span class="string">", 数据="</span> + data +</span><br><span class="line">                <span class="string">", 错误消息='"</span> + error + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="页面的编写"><a href="#页面的编写" class="headerlink" title="页面的编写"></a>页面的编写</h4><p>因为项目的前端页面都是由<code>Bootstrap</code>开发的,所以我们要先去下载<code>Bootstrap</code>或者是使用在线的CDN.<br> -<a href="http://www.bootcss.com/" target="_blank" rel="noopener">Bootstrap中文官网</a><br> -<a href="http://v3.bootcss.com/" target="_blank" rel="noopener">Bootstrap中文文档</a><br> 使用在线CDN引入的方法:<br> <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 最新版本的 Bootstrap 核心 CSS 文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"</span> <span class="attr">integrity</span>=<span class="string">"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 可选的 Bootstrap 主题文件（一般不用引入） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"</span> <span class="attr">integrity</span>=<span class="string">"sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 最新的 Bootstrap 核心 JavaScript 文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>文档里面写的很详细,然后我这里是使用离线版本的,方便我们本地调试,避免出现什么别的因素干扰我们:</p><ul><li>首先下载<code>JQuery</code>,因为<code>Bootstrap</code>就是依赖<code>JQuery</code>的</li><li>然后下载<code>Bootstrap</code></li><li><p>然后下载一个倒计时插件<code>jquery.countdown.min.js</code><br>-再下载一个操作<code>Cookie</code>插件<code>jquery.cookie.min.js</code><br>如图放置:<br><img src="/images/resources.jpg" alt="资源图"></p></li><li><p>首先编写一个公共的头部<code>jsp</code>文件,位于<code>WEB-INF</code>下<code>common</code>中的<code>head.jsp</code></p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"$&#123;pageContext.request.contextPath&#125;/resources/plugins/bootstrap-3.3.0/css/bootstrap.min.css"</span> type=<span class="string">"text/css"</span>&gt;</span><br><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"$&#123;pageContext.request.contextPath&#125;/resources/plugins/bootstrap-3.3.0/css/bootstrap-theme.min.css"</span> type=<span class="string">"text/css"</span>&gt;</span><br><span class="line">  ````   </span><br><span class="line">  - 然后编写一个公共的`jstl`标签库文件,位于`WEB-INF`下`common`中的`tag.jsp`</span><br><span class="line">  ```jsp</span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fmt"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/fmt"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fn"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/functions"</span> %&gt;</span><br><span class="line">```  </span><br><span class="line">  - 编写列表页面,位于`WEB-INF`下`common`中的`list.jsp`</span><br><span class="line"></span><br><span class="line">  ```jsp</span><br><span class="line">  &lt;%<span class="meta">@page</span> contentType=<span class="string">"text/html; charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">  &lt;%<span class="meta">@include</span> file=<span class="string">"common/tag.jsp"</span> %&gt;</span><br><span class="line">  &lt;!DOCTYPE html&gt;</span><br><span class="line">  &lt;html lang=<span class="string">"zh-CN"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">      &lt;title&gt;秒杀列表&lt;/title&gt;</span><br><span class="line">      &lt;%<span class="meta">@include</span> file=<span class="string">"common/head.jsp"</span> %&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"container"</span>&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel panel-default"</span>&gt;</span><br><span class="line">          &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-heading text-center"</span>&gt;</span><br><span class="line">              &lt;h2&gt;秒杀列表&lt;/h2&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">          &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-body"</span>&gt;</span><br><span class="line">              &lt;table <span class="class"><span class="keyword">class</span></span>=<span class="string">"table table-hover"</span>&gt;</span><br><span class="line">                  &lt;thead&gt;</span><br><span class="line">                  &lt;tr&gt;</span><br><span class="line">                      &lt;td&gt;名称&lt;/td&gt;</span><br><span class="line">                      &lt;td&gt;库存&lt;/td&gt;</span><br><span class="line">                      &lt;td&gt;开始时间&lt;/td&gt;</span><br><span class="line">                      &lt;td&gt;结束时间&lt;/td&gt;</span><br><span class="line">                      &lt;td&gt;创建时间&lt;/td&gt;</span><br><span class="line">                      &lt;td&gt;详情页&lt;/td&gt;</span><br><span class="line">                  &lt;/tr&gt;</span><br><span class="line">                  &lt;/thead&gt;</span><br><span class="line">                  &lt;tbody&gt;</span><br><span class="line">                  &lt;c:forEach items=<span class="string">"$&#123;list&#125;"</span> <span class="keyword">var</span>=<span class="string">"sk"</span>&gt;</span><br><span class="line">                      &lt;tr&gt;</span><br><span class="line">                          &lt;td&gt;$&#123;sk.name&#125;&lt;/td&gt;</span><br><span class="line">                          &lt;td&gt;$&#123;sk.number&#125;&lt;/td&gt;</span><br><span class="line">                          &lt;td&gt;&lt;fmt:formatDate value="$&#123;sk.startTime&#125;" pattern="yyyy-MM-dd HH:mm:ss"/&gt;&lt;/td&gt;</span><br><span class="line">                                                   &lt;td&gt;&lt;fmt:formatDate value="$&#123;sk.endTime&#125;" pattern="yyyy-MM-dd HH:mm:ss"/&gt;&lt;/td&gt;</span><br><span class="line">                                                   &lt;td&gt;&lt;fmt:formatDate value="$&#123;sk.createTIme&#125;" pattern="yyyy-MM-dd HH:mm:ss"/&gt;&lt;/td&gt;</span><br><span class="line">                          &lt;td&gt;&lt;a class="btn btn-info" href="/seckill/$&#123;sk.seckillId&#125;/detail" target="_blank"&gt;详情&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">                      &lt;/tr&gt;</span><br><span class="line">                  &lt;/c:forEach&gt;</span><br><span class="line">                  &lt;/tbody&gt;</span><br><span class="line">              &lt;/table&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">  &lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/plugins/jquery.js"&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/plugins/bootstrap-3.3.0/js/bootstrap.min.js"&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/html&gt;</span><br><span class="line">  ```</span><br><span class="line"></span><br><span class="line"> - 编写列表页面,位于`WEB-INF`下`common`中的`detail.jsp`,秒杀详情页面</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ```jsp</span><br><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: jianrongsun</span><br><span class="line">  Date: <span class="number">17</span>-<span class="number">5</span>-<span class="number">25</span></span><br><span class="line">  Time: 下午<span class="number">5</span>:<span class="number">03</span></span><br><span class="line">  To change <span class="keyword">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%<span class="meta">@include</span> file=<span class="string">"common/tag.jsp"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;秒杀商品详情页面&lt;/title&gt;</span><br><span class="line">    &lt;%<span class="meta">@include</span> file=<span class="string">"common/head.jsp"</span> %&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"container"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel panel-default"</span>&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-heading"</span>&gt;</span><br><span class="line">            &lt;h1&gt;$&#123;seckill.name&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-body"</span>&gt;</span><br><span class="line">            &lt;h2 <span class="class"><span class="keyword">class</span></span>=<span class="string">"text-danger"</span>&gt;</span><br><span class="line">                &lt;span class="glyphicon glyphicon-time"&gt;&lt;/span&gt;</span><br><span class="line">                &lt;span class="glyphicon" id="seckill-box"&gt;&lt;/span&gt;</span><br><span class="line">            &lt;/h2&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id=<span class="string">"killPhoneModal"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal fade"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-dialog"</span>&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-content"</span>&gt;</span><br><span class="line">            &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-header"</span>&gt;</span><br><span class="line">                &lt;h3 <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-title text-center"</span>&gt;</span><br><span class="line">                    &lt;span class="glyphicon glyphicon-phone"&gt;&lt;/span&gt;秒杀电话:</span><br><span class="line">                &lt;/h3&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-body"</span>&gt;</span><br><span class="line">            &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"row"</span>&gt;</span><br><span class="line">                &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"col-xs-8 col-xs-offset-2"</span>&gt;</span><br><span class="line">                    &lt;input type=<span class="string">"text"</span> name=<span class="string">"killPhone"</span> id=<span class="string">"killPhoneKey"</span> placeholder=<span class="string">"填写手机号码"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"form-control"</span>&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"modal-footer"</span>&gt;</span><br><span class="line">            &lt;span id="killPhoneMessage" class="glyphicon"&gt;&lt;/span&gt;</span><br><span class="line">            &lt;button type=<span class="string">"button"</span> id=<span class="string">"killPhoneBtn"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"btn btn-success"</span>&gt;</span><br><span class="line">                &lt;span class="glyphicon glyphicon-phone"&gt;&lt;/span&gt;</span><br><span class="line">                提交</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/plugins/jquery.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/plugins/bootstrap-3.3.0/js/bootstrap.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/plugins/jquery.cookie.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/plugins/jquery.countdown.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/script/seckill.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    $(function () &#123;</span><br><span class="line">        <span class="keyword">var</span> startTimeVal = <span class="string">"$&#123;seckill.startTime.toLocalDate()&#125; "</span> + seckill.cloneZero(<span class="string">"$&#123;seckill.startTime.toLocalTime()&#125;"</span>);</span><br><span class="line">        <span class="keyword">var</span> endTimeVal = <span class="string">"$&#123;seckill.endTime.toLocalDate()&#125; "</span> + seckill.cloneZero(<span class="string">"$&#123;seckill.endTime.toLocalTime()&#125;"</span>);</span><br><span class="line">        console.log(<span class="string">"startTimeVal========"</span> + startTimeVal);</span><br><span class="line">        console.log(<span class="string">"endTimeVal========"</span> + endTimeVal);</span><br><span class="line">        <span class="comment">// 传入参数</span></span><br><span class="line">        seckill.detail.init(&#123;</span><br><span class="line">            seckillId:$&#123;seckill.seckillId&#125;,</span><br><span class="line">            startTime: startTimeVal,</span><br><span class="line">            endTime: endTimeVal</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br><span class="line">```</span><br><span class="line">  然后把项目运行一下我们又会碰到一个错误就是`jstl`中的`fmt`标签格式化时间只能格式化`java.Util.Date`类型的日期跟时间,而在我们这里我么使用了`java8`的`LocalDateTIme`,所以解析时间会出异常,这时我们应该想到自己去实现`jstl`标签来自定义解析这个时间日期</span><br><span class="line">  自定义标签步骤如下:  </span><br><span class="line">  - 在` /WEB-INF `创建目录 `tags`</span><br><span class="line">  - 然后创建一个文件` localDateTime.tag` 在`tags`目录下</span><br><span class="line">     + `localData.tag`用来格式化日期</span><br><span class="line">      + `localDataTime.tag`用来格式化日期跟时间的组合,也就是数据库中的`Timestamp`类型</span><br><span class="line">  -然后在`localDataTime.tag`中写自己自定义的格式化流程</span><br><span class="line">  ```xml</span><br><span class="line">&lt;%--格式化java8的LocalDatime,解决jstl不支持java8时间的问题--%&gt;</span><br><span class="line">&lt;%@ tag body-content=<span class="string">"empty"</span> pageEncoding=<span class="string">"UTF-8"</span> trimDirectiveWhitespaces=<span class="string">"true"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fmt"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/fmt"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fn"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/functions"</span> %&gt;</span><br><span class="line">&lt;%--        这里是定义页面使用标签中的属性设置,&lt;tags:localDataTime dateTime=<span class="string">"$&#123;sk.createTIme&#125;"</span>/&gt;     --%&gt;</span><br><span class="line">&lt;%@ attribute name=<span class="string">"dateTime"</span> required=<span class="string">"true"</span> type=<span class="string">"java.time.LocalDateTime"</span> %&gt;</span><br><span class="line">&lt;%@ attribute name=<span class="string">"pattern"</span> required=<span class="string">"false"</span> type=<span class="string">"java.lang.String"</span> %&gt;</span><br><span class="line">&lt;%--首选判断日期时间转换规则是否存在,不存在给出默认的规则--%&gt;</span><br><span class="line">&lt;c:<span class="keyword">if</span> test=<span class="string">"$&#123;empty pattern&#125;"</span>&gt;</span><br><span class="line">    &lt;c:set <span class="keyword">var</span>=<span class="string">"pattern"</span> value=<span class="string">"yyyy-MM-dd HH:mm:ss"</span>/&gt;</span><br><span class="line">&lt;/c:if&gt;</span><br><span class="line">&lt;c:set <span class="keyword">var</span>=<span class="string">"datetime"</span> value=<span class="string">"$&#123;dateTime&#125;"</span>/&gt;                        &lt;%-- 获取jsp页面传入的【 日期时间 】,格式为【 <span class="number">2017</span>-<span class="number">5</span>-<span class="number">26</span>T13:<span class="number">59</span>:<span class="number">12</span>  】 --%&gt;</span><br><span class="line">&lt;c:set <span class="keyword">var</span>=<span class="string">"time"</span> value=<span class="string">"$&#123;fn:substringAfter(datetime, 'T')&#125;"</span>/&gt;     &lt;%--   获取页面传过来的【时间T】后面的 【  时:分:秒 】的值  --%&gt;</span><br><span class="line">&lt;c:set <span class="keyword">var</span>=<span class="string">"timeLength"</span> value=<span class="string">"$&#123;fn:length(time)&#125;"</span>/&gt;                &lt;%--  获取页面传来的 【 时:分:秒 的长度  】 --%&gt;</span><br><span class="line">&lt;c:set <span class="keyword">var</span>=<span class="string">"generalLength"</span> value=<span class="string">"$&#123;fn:length('123456')&#125;"</span>/&gt;         &lt;%--  这里定义了一个【Integer】类型的值,值为字符串 【<span class="number">123456</span> 】的长度   --%&gt;</span><br><span class="line">&lt;c:set <span class="keyword">var</span>=<span class="string">"cloneZero"</span> value=<span class="string">":00"</span>/&gt;                                 &lt;%--   这里设置一个值为【String】的字符串,     --%&gt;</span><br><span class="line">&lt;%-- 当  时:分:秒 不足<span class="number">6</span>位的时候就说明缺少秒,我们给它自动补充 :<span class="number">00</span>    --%&gt;</span><br><span class="line">&lt;c:<span class="keyword">if</span> test=<span class="string">"$&#123;timeLength lt generalLength&#125;"</span>&gt;</span><br><span class="line">    &lt;c:set <span class="keyword">var</span>=<span class="string">"datetimeCloneZero"</span></span><br><span class="line">           value=<span class="string">"$&#123;datetime&#125;$&#123;cloneZero&#125;"</span>/&gt;          &lt;%--  拼接页面传过来的  【 时：分 】  ,补充一个【秒数】,EL中 + 为相加,非拼接字符串   --%&gt;</span><br><span class="line">    &lt;c:set <span class="keyword">var</span>=<span class="string">"cleandDateTime"</span></span><br><span class="line">           value=<span class="string">"$&#123;fn:replace(datetimeCloneZero,'T',' ')&#125;"</span>/&gt;      &lt;%--  把java8日期时间中的【 T 】给去掉,换成一个空的字符串    --%&gt;</span><br><span class="line">&lt;/c:if&gt;</span><br><span class="line">&lt;%--  当页面传过来的时间大于<span class="number">6</span>位时说明时间时完整的,不进行自动填充【 :<span class="number">00</span> 】,直接把日期时间中的 【 T 】 替换为空字符串 --%&gt;</span><br><span class="line">&lt;c:<span class="keyword">if</span> test=<span class="string">"$&#123;timeLength gt generalLength&#125;"</span>&gt;</span><br><span class="line">    &lt;c:set <span class="keyword">var</span>=<span class="string">"cleandDateTime"</span> value=<span class="string">"$&#123;fn:replace(datetime,'T',' ')&#125;"</span>/&gt;</span><br><span class="line">&lt;/c:if&gt;</span><br><span class="line">&lt;%--   解析时间, type=<span class="string">"BOTH"</span>为同时解析日期跟时间    --%&gt;</span><br><span class="line">&lt;fmt:parseDate value=<span class="string">"$&#123;cleandDateTime&#125;"</span> <span class="keyword">var</span>=<span class="string">"parsedDateTime"</span> pattern=<span class="string">"$&#123;pattern&#125;"</span> type=<span class="string">"BOTH"</span>/&gt;</span><br><span class="line">&lt;fmt:formatDate value=<span class="string">"$&#123;parsedDateTime&#125;"</span> pattern=<span class="string">"$&#123;pattern&#125;"</span> type=<span class="string">"BOTH"</span>/&gt;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">- `localData.tag`的内容就比较简单了</span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">&lt;%@ tag body-content=<span class="string">"empty"</span> pageEncoding=<span class="string">"UTF-8"</span> trimDirectiveWhitespaces=<span class="string">"true"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fmt"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/fmt"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ attribute name=<span class="string">"date"</span> required=<span class="string">"true"</span> type=<span class="string">"java.time.LocalDate"</span> %&gt;</span><br><span class="line">&lt;%@ attribute name=<span class="string">"pattern"</span> required=<span class="string">"false"</span> type=<span class="string">"java.lang.String"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;c:<span class="keyword">if</span> test=<span class="string">"$&#123;empty pattern&#125;"</span>&gt;</span><br><span class="line">    &lt;c:set <span class="keyword">var</span>=<span class="string">"pattern"</span> value=<span class="string">"MM/dd/yyyy"</span>/&gt;</span><br><span class="line">&lt;/c:if&gt;</span><br><span class="line">&lt;fmt:parseDate value=<span class="string">"$&#123;date&#125;"</span> <span class="keyword">var</span>=<span class="string">"parsedDate"</span> type=<span class="string">"date"</span>/&gt;</span><br><span class="line">&lt;fmt:formatDate value=<span class="string">"$&#123;parsedDate&#125;"</span> type=<span class="string">"date"</span> pattern=<span class="string">"$&#123;pattern&#125;"</span>/&gt;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"> - 然后我们去页面导入需要的标签,然后去使用,修改`list.jsp`文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ```jsp</span><br><span class="line">&lt;%<span class="meta">@page</span> contentType=<span class="string">"text/html; charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%<span class="meta">@include</span> file=<span class="string">"common/tag.jsp"</span> %&gt;  </span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">"tags"</span> tagdir=<span class="string">"/WEB-INF/tags"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh-CN"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;秒杀列表&lt;/title&gt;</span><br><span class="line">    &lt;%<span class="meta">@include</span> file=<span class="string">"common/head.jsp"</span> %&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"container"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel panel-default"</span>&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-heading text-center"</span>&gt;</span><br><span class="line">            &lt;h2&gt;秒杀列表&lt;/h2&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"panel-body"</span>&gt;</span><br><span class="line">            &lt;table <span class="class"><span class="keyword">class</span></span>=<span class="string">"table table-hover"</span>&gt;</span><br><span class="line">                &lt;thead&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td&gt;名称&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;库存&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;开始时间&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;结束时间&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;创建时间&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;详情页&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">                &lt;/thead&gt;</span><br><span class="line">                &lt;tbody&gt;</span><br><span class="line">                &lt;c:forEach items=<span class="string">"$&#123;list&#125;"</span> <span class="keyword">var</span>=<span class="string">"sk"</span>&gt;</span><br><span class="line">                    &lt;tr&gt;</span><br><span class="line">                        &lt;td&gt;$&#123;sk.name&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;$&#123;sk.number&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&lt;tags:localDataTime dateTime="$&#123;sk.startTime&#125;"/&gt;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&lt;tags:localDataTime dateTime="$&#123;sk.endTime&#125;"/&gt;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&lt;tags:localDataTime dateTime="$&#123;sk.createTIme&#125;"/&gt;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&lt;a class="btn btn-info" href="/seckill/$&#123;sk.seckillId&#125;/detail" target="_blank"&gt;详情&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">                    &lt;/tr&gt;</span><br><span class="line">                &lt;/c:forEach&gt;</span><br><span class="line">                &lt;/tbody&gt;</span><br><span class="line">            &lt;/table&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/plugins/jquery.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src="$&#123;pageContext.request.contextPath&#125;/resources/plugins/bootstrap-3.3.0/js/bootstrap.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">```</span><br><span class="line"> 在这里我们修改了几个地方:</span><br><span class="line"></span><br><span class="line"> ```jsp</span><br><span class="line"> &lt;%<span class="meta">@taglib</span> prefix=<span class="string">"tags"</span> tagdir=<span class="string">"/WEB-INF/tags"</span> %&gt;</span><br><span class="line"> ```</span><br><span class="line"></span><br><span class="line">然后我们的格式就应该可以正常被格式化出来了</span><br><span class="line"> -  建立一个模块化的`seckill.js`文件,位于`Webapp`下 `resources`下`script`文件夹下,文件内容如下:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ```js</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  模块化javaScript</span></span><br><span class="line"><span class="comment"> * Created by jianrongsun on 17-5-25.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> seckill = &#123;</span><br><span class="line">    <span class="comment">// 封装秒杀相关的ajax的url</span></span><br><span class="line">    URL: &#123;</span><br><span class="line">        now: function () &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"/seckill/time/now"</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        exposer: function (seckillId) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"/seckill/"</span> + seckillId + <span class="string">"/exposer"</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        execution: function (seckillId, md5) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"/seckill/"</span> + seckillId + <span class="string">"/"</span> + md5 + <span class="string">"/execution"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 验证手机号码</span></span><br><span class="line">    validatePhone: function (phone) &#123;</span><br><span class="line">        <span class="keyword">return</span> !!(phone &amp;&amp; phone.length === <span class="number">11</span> &amp;&amp; !isNaN(phone));</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 详情页秒杀业务逻辑</span></span><br><span class="line">    detail: &#123;</span><br><span class="line">        <span class="comment">// 详情页开始初始化</span></span><br><span class="line">        init: function (params) &#123;</span><br><span class="line">            console.log(<span class="string">"获取手机号码"</span>);</span><br><span class="line">            <span class="comment">// 手机号验证登录,计时交互</span></span><br><span class="line">            <span class="keyword">var</span> userPhone = $.cookie(<span class="string">'userPhone'</span>);</span><br><span class="line">            <span class="comment">// 验证手机号</span></span><br><span class="line">            <span class="keyword">if</span> (!seckill.validatePhone(userPhone)) &#123;</span><br><span class="line">                console.log(<span class="string">"未填写手机号码"</span>);</span><br><span class="line">                <span class="comment">// 验证手机控制输出</span></span><br><span class="line">                <span class="keyword">var</span> killPhoneModal = $(<span class="string">"#killPhoneModal"</span>);</span><br><span class="line">                killPhoneModal.modal(&#123;</span><br><span class="line">                    show: <span class="keyword">true</span>,  <span class="comment">// 显示弹出层</span></span><br><span class="line">                    backdrop: <span class="string">'static'</span>,  <span class="comment">// 静止位置关闭</span></span><br><span class="line">                    keyboard: <span class="keyword">false</span>    <span class="comment">// 关闭键盘事件</span></span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                $(<span class="string">"#killPhoneBtn"</span>).click(function () &#123;</span><br><span class="line">                    console.log(<span class="string">"提交手机号码按钮被点击"</span>);</span><br><span class="line">                    <span class="keyword">var</span> inputPhone = $(<span class="string">"#killPhoneKey"</span>).val();</span><br><span class="line">                    console.log(<span class="string">"inputPhone"</span> + inputPhone);</span><br><span class="line">                    <span class="keyword">if</span> (seckill.validatePhone(inputPhone)) &#123;</span><br><span class="line">                        <span class="comment">// 把电话写入cookie</span></span><br><span class="line">                        $.cookie(<span class="string">'userPhone'</span>, inputPhone, &#123;expires: <span class="number">7</span>, path: <span class="string">'/seckill'</span>&#125;);</span><br><span class="line">                        <span class="comment">// 验证通过 刷新页面</span></span><br><span class="line">                        window.location.reload();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// todo 错误文案信息写到前端</span></span><br><span class="line">                        $(<span class="string">"#killPhoneMessage"</span>).hide().html(<span class="string">"&lt;label class='label label-danger'&gt;手机号码错误&lt;/label&gt;"</span>).show(<span class="number">300</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                console.log(<span class="string">"在cookie中找到了电话号码,开启计时"</span>);</span><br><span class="line">                <span class="comment">// 已经登录了就开始计时交互</span></span><br><span class="line">                <span class="keyword">var</span> startTime = params[<span class="string">'startTime'</span>];</span><br><span class="line">                <span class="keyword">var</span> endTime = params[<span class="string">'endTime'</span>];</span><br><span class="line">                <span class="keyword">var</span> seckillId = params[<span class="string">'seckillId'</span>];</span><br><span class="line">                console.log(<span class="string">"开始秒杀时间======="</span> + startTime);</span><br><span class="line">                console.log(<span class="string">"结束秒杀时间========"</span> + endTime);</span><br><span class="line">                $.get(seckill.URL.now(), &#123;&#125;, function (result) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">'success'</span>]) &#123;</span><br><span class="line">                        <span class="keyword">var</span> nowTime = seckill.convertTime(result[<span class="string">'data'</span>]);</span><br><span class="line">                        console.log(<span class="string">"服务器当前的时间=========="</span> + nowTime);</span><br><span class="line">                        <span class="comment">// 进行秒杀商品的时间判断,然后计时交互</span></span><br><span class="line">                        seckill.countDown(seckillId, nowTime, startTime, endTime);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        console.log(<span class="string">'结果:'</span> + result);</span><br><span class="line">                        console.log(<span class="string">'result'</span> + result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    handlerSeckill: function (seckillId, mode) &#123;</span><br><span class="line">        <span class="comment">// 获取秒杀地址</span></span><br><span class="line">        mode.hide().html(<span class="string">'&lt;button class="btn btn-primary btn-lg" id="killBtn"&gt;开始秒杀&lt;/button&gt;'</span>);</span><br><span class="line">        console.debug(<span class="string">"开始进行秒杀地址获取"</span>);</span><br><span class="line">        $.get(seckill.URL.exposer(seckillId), &#123;&#125;, function (result) &#123;</span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; result[<span class="string">'success'</span>]) &#123;</span><br><span class="line">                <span class="keyword">var</span> exposer = result[<span class="string">'data'</span>];</span><br><span class="line">                <span class="keyword">if</span> (exposer[<span class="string">'exposed'</span>]) &#123;</span><br><span class="line">                    console.log(<span class="string">"有秒杀地址接口"</span>);</span><br><span class="line">                    <span class="comment">// 开启秒杀,获取秒杀地址</span></span><br><span class="line">                    <span class="keyword">var</span> md5 = exposer[<span class="string">'md5'</span>];</span><br><span class="line">                    <span class="keyword">var</span> killUrl = seckill.URL.execution(seckillId, md5);</span><br><span class="line">                    console.log(<span class="string">"秒杀的地址为:"</span> + killUrl);</span><br><span class="line">                    <span class="comment">// 绑定一次点击事件</span></span><br><span class="line">                    $(<span class="string">"#killBtn"</span>).one(<span class="string">'click'</span>, function () &#123;</span><br><span class="line">                        console.log(<span class="string">"开始进行秒杀,按钮被禁用"</span>);</span><br><span class="line">                        <span class="comment">// 执行秒杀请求,先禁用按钮</span></span><br><span class="line">                        $(<span class="keyword">this</span>).addClass(<span class="string">"disabled"</span>);</span><br><span class="line">                        <span class="comment">// 发送秒杀请求</span></span><br><span class="line">                        $.post(killUrl, &#123;&#125;, function (result) &#123;</span><br><span class="line">                            <span class="keyword">var</span> killResult = result[<span class="string">'data'</span>];</span><br><span class="line">                            <span class="keyword">var</span> state = killResult[<span class="string">'state'</span>];</span><br><span class="line">                            <span class="keyword">var</span> stateInfo = killResult[<span class="string">'stateInfo'</span>];</span><br><span class="line">                            console.log(<span class="string">"秒杀状态"</span> + stateInfo);</span><br><span class="line">                            <span class="comment">// 显示秒杀结果</span></span><br><span class="line">                            mode.html(<span class="string">'&lt;span class="label label-success"&gt;'</span> + stateInfo + <span class="string">'&lt;/span&gt;'</span>);</span><br><span class="line"></span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">                    &#125;);</span><br><span class="line">                    mode.show();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    console.warn(<span class="string">"还没有暴露秒杀地址接口,无法进行秒杀"</span>);</span><br><span class="line">                    <span class="comment">// 未开启秒杀</span></span><br><span class="line">                    <span class="keyword">var</span> now = seckill.convertTime(exposer[<span class="string">'now'</span>]);</span><br><span class="line">                    <span class="keyword">var</span> start = seckill.convertTime(exposer[<span class="string">'start'</span>]);</span><br><span class="line">                    <span class="keyword">var</span> end = seckill.convertTime(exposer[<span class="string">'end'</span>]);</span><br><span class="line">                    console.log(<span class="string">"当前时间"</span> + now);</span><br><span class="line">                    console.log(<span class="string">"开始时间"</span> + start);</span><br><span class="line">                    console.log(<span class="string">"结束时间"</span> + end);</span><br><span class="line">                    console.log(<span class="string">"开始倒计时"</span>);</span><br><span class="line">                    console.debug(<span class="string">"开始进行倒计时"</span>);</span><br><span class="line">                    seckill.countDown(seckillId, now, start, end);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                console.error(<span class="string">"服务器端查询秒杀商品详情失败"</span>);</span><br><span class="line">                console.log(<span class="string">'result'</span> + result.valueOf());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    countDown: function (seckillId, nowTime, startTime, endTime) &#123;</span><br><span class="line">        console.log(<span class="string">"秒杀的商品ID:"</span> + seckillId + <span class="string">",服务器当前时间："</span> + nowTime + <span class="string">",开始秒杀的时间:"</span> + startTime + <span class="string">",结束秒杀的时间"</span> + endTime);</span><br><span class="line">        <span class="comment">//  获取显示倒计时的文本域</span></span><br><span class="line">        <span class="keyword">var</span> seckillBox = $(<span class="string">"#seckill-box"</span>);</span><br><span class="line">        <span class="comment">//  获取时间戳进行时间的比较</span></span><br><span class="line">        nowTime = <span class="keyword">new</span> Date(nowTime).valueOf();</span><br><span class="line">        startTime = <span class="keyword">new</span> Date(startTime).valueOf();</span><br><span class="line">        endTime = <span class="keyword">new</span> Date(endTime).valueOf();</span><br><span class="line">        console.log(<span class="string">"转换后的Date类型当前时间戳"</span> + nowTime);</span><br><span class="line">        console.log(<span class="string">"转换后的Date类型开始时间戳"</span> + startTime);</span><br><span class="line">        console.log(<span class="string">"转换后的Date类型结束时间戳"</span> + endTime);</span><br><span class="line">        <span class="keyword">if</span> (nowTime &lt; endTime &amp;&amp; nowTime &gt; startTime) &#123;</span><br><span class="line">            <span class="comment">// 秒杀开始</span></span><br><span class="line">            console.log(<span class="string">"秒杀可以开始,两个条件符合"</span>);</span><br><span class="line">            seckill.handlerSeckill(seckillId, seckillBox);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nowTime &gt; endTime) &#123;</span><br><span class="line">            alert(nowTime &gt; endTime);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// console.log(nowTime + "&gt;" + startTime); 秒杀结束应该根据结束时间判断</span></span><br><span class="line"></span><br><span class="line">             console.log(nowTime + <span class="string">"&gt;"</span> + endTime);</span><br><span class="line">            <span class="comment">// 秒杀结束</span></span><br><span class="line">            console.warn(<span class="string">"秒杀已经结束了,当前时间为:"</span> + nowTime + <span class="string">",秒杀结束时间为"</span> + endTime);</span><br><span class="line">            seckillBox.html(<span class="string">"秒杀结束"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            console.log(<span class="string">"秒杀还没开始"</span>);</span><br><span class="line">            alert(nowTime &lt; startTime);</span><br><span class="line">            <span class="comment">// 秒杀未开启</span></span><br><span class="line">            <span class="keyword">var</span> killTime = <span class="keyword">new</span> Date(startTime + <span class="number">1000</span>);</span><br><span class="line">            console.log(killTime);</span><br><span class="line">            console.log(<span class="string">"开始计时效果"</span>);</span><br><span class="line">            seckillBox.countdown(killTime, function (event) &#123;</span><br><span class="line">                <span class="comment">// 事件格式</span></span><br><span class="line">                <span class="keyword">var</span> format = event.strftime(<span class="string">"秒杀倒计时: %D天 %H时 %M分 %S秒"</span>);</span><br><span class="line">                console.log(format);</span><br><span class="line">                seckillBox.html(format);</span><br><span class="line">            &#125;).on(<span class="string">'finish.countdown'</span>, function () &#123;</span><br><span class="line">                <span class="comment">// 事件完成后回调事件,获取秒杀地址,控制业务逻辑</span></span><br><span class="line">                console.log(<span class="string">"准备执行回调,获取秒杀地址,执行秒杀"</span>);</span><br><span class="line">                console.log(<span class="string">"倒计时结束"</span>);</span><br><span class="line">                seckill.handlerSeckill(seckillId, seckillBox);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    cloneZero: function (time) &#123;</span><br><span class="line">        <span class="keyword">var</span> cloneZero = <span class="string">":00"</span>;</span><br><span class="line">        <span class="keyword">if</span> (time.length &lt; <span class="number">6</span>) &#123;</span><br><span class="line">            console.warn(<span class="string">"需要拼接时间"</span>);</span><br><span class="line">            time = time + cloneZero;</span><br><span class="line">            <span class="keyword">return</span> time;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            console.log(<span class="string">"时间是完整的"</span>);</span><br><span class="line">            <span class="keyword">return</span> time;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    convertTime: function (localDateTime) &#123;</span><br><span class="line">        <span class="keyword">var</span> year = localDateTime.year;</span><br><span class="line">        <span class="keyword">var</span> monthValue = localDateTime.monthValue;</span><br><span class="line">        <span class="keyword">var</span> dayOfMonth = localDateTime.dayOfMonth;</span><br><span class="line">        <span class="keyword">var</span> hour = localDateTime.hour;</span><br><span class="line">        <span class="keyword">var</span> minute = localDateTime.minute;</span><br><span class="line">        <span class="keyword">var</span> second = localDateTime.second;</span><br><span class="line">        <span class="keyword">return</span> year + <span class="string">"-"</span> + monthValue + <span class="string">"-"</span> + dayOfMonth + <span class="string">" "</span> + hour + <span class="string">":"</span> + minute + <span class="string">":"</span> + second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">自定义jstl标签参考资料  </span><br><span class="line">[stackoverflow上的资料<span class="number">1</span>](https:<span class="comment">//stackoverflow.com/questions/35606551/jstl-localdatetime-format)  </span></span><br><span class="line">[stackoverflow上的资料<span class="number">2</span>](https:<span class="comment">//stackoverflow.com/questions/30230517/taglib-to-display-java-time-localdate-formatted)  </span></span><br><span class="line">编写完了就部署运行吧,不出意外的话就是这个样子的:  </span><br><span class="line">![完整的页面](/images/result_1.jpg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">### (四)Java高并发秒杀API之高并发优化</span><br><span class="line"></span><br><span class="line">#### 下载`Redis`</span><br><span class="line">  - 下载完后解压压缩包</span><br><span class="line">  + 进入解压后的文件夹里面 ,执行命令  `make `</span><br><span class="line">   + 然后再执行`sudo make install`</span><br><span class="line">   + 最后再启动`REdis`,启动命令为`redis-server`</span><br><span class="line">   + 执行命令<span class="string">'redis-cli -p 6379'</span>查看运行情况</span><br><span class="line"></span><br><span class="line">####  使用`Java`操作`Redis`</span><br><span class="line">+ 导入操作`Redis`的`jedis`的 jar包</span><br><span class="line">```xml</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;redis.clients&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jedis&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.9.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">```</span><br><span class="line">+ 添加`protostuff-core`以及`protostuff-runtime`序列化jar包</span><br><span class="line">```xml</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.dyuproject.protostuff&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;protostuff-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.dyuproject.protostuff&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;protostuff-runtime&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">+ 在`com.suny.dao`下建包`cache`</span><br><span class="line">  + 然后建立类`RedisDao`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ```java</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 操作Redis的dao类</span></span><br><span class="line"><span class="comment"> * Created by 孙建荣 on 17-5-27.下午4:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDao</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RuntimeSchema&lt;Seckill&gt; schema = RuntimeSchema.createFrom(Seckill.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisDao</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        jedisPool = <span class="keyword">new</span> JedisPool(ip, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Seckill <span class="title">getSeckill</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// redis操作业务逻辑</span></span><br><span class="line">        <span class="keyword">try</span> (Jedis jedis = jedisPool.getResource()) &#123;</span><br><span class="line">            String key = <span class="string">"seckill:"</span> + seckillId;</span><br><span class="line">            <span class="comment">// 并没有实现内部序列化操作</span></span><br><span class="line">            <span class="comment">//get-&gt;byte[]字节数组-&gt;反序列化&gt;Object(Seckill)</span></span><br><span class="line">            <span class="comment">// 采用自定义的方式序列化</span></span><br><span class="line">            <span class="comment">// 缓存获取到</span></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = jedis.get(key.getBytes());</span><br><span class="line">            <span class="keyword">if</span> (bytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 空对象</span></span><br><span class="line">                Seckill seckill = schema.newMessage();</span><br><span class="line">                ProtostuffIOUtil.mergeFrom(bytes, seckill, schema);</span><br><span class="line">                <span class="comment">// seckill被反序列化</span></span><br><span class="line">                <span class="keyword">return</span> seckill;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">putSeckill</span><span class="params">(Seckill seckill)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  set Object(Seckill) -&gt; 序列化 -&gt; byte[]</span></span><br><span class="line">        <span class="keyword">try</span> (Jedis jedis = jedisPool.getResource()) &#123;</span><br><span class="line">            String key = <span class="string">"seckill:"</span> + seckill.getSeckillId();</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = ProtostuffIOUtil.toByteArray(seckill, schema,</span><br><span class="line">                    LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE));</span><br><span class="line">            <span class="comment">// 超时缓存</span></span><br><span class="line">            <span class="keyword">int</span> timeout=<span class="number">60</span>*<span class="number">60</span>;</span><br><span class="line">            <span class="keyword">return</span> jedis.setex(key.getBytes(), timeout, bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">+ 下一步是在在`applicationContext-dao.xml`中注入`redisDao`</span><br><span class="line">```xml</span><br><span class="line"> &lt;!--注入redisDao--&gt;</span><br><span class="line">    &lt;bean id=<span class="string">"redisDao"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.suny.dao.cache.RedisDao"</span>&gt;</span><br><span class="line">        &lt;!--构造方法注入值--&gt;</span><br><span class="line">        &lt;constructor-arg index=<span class="string">"0"</span> value=<span class="string">"localhost"</span>/&gt;</span><br><span class="line">        &lt;constructor-arg index=<span class="string">"1"</span> value=<span class="string">"6379"</span>/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">```</span><br><span class="line">+ 改造`exportSeckillUrl`方法,一定要先注入`redisDao`</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisDao redisDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exposer <span class="title">exportSeckillUrl</span><span class="params">(<span class="keyword">long</span> seckillId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据秒杀的ID去查询是否存在这个商品</span></span><br><span class="line">       <span class="comment">/* Seckill seckill = seckillMapper.queryById(seckillId);</span></span><br><span class="line"><span class="comment">        if (seckill == null) &#123;</span></span><br><span class="line"><span class="comment">            logger.warn("查询不到这个秒杀产品的记录");</span></span><br><span class="line"><span class="comment">            return new Exposer(false, seckillId);</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">        Seckill seckill = redisDao.getSeckill(seckillId);</span><br><span class="line">        <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 访问数据库读取数据</span></span><br><span class="line">            seckill = seckillMapper.queryById(seckillId);</span><br><span class="line">            <span class="keyword">if</span> (seckill == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 放入redis</span></span><br><span class="line">                redisDao.putSeckill(seckill);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否还没到秒杀时间或者是过了秒杀时间</span></span><br><span class="line">        LocalDateTime startTime = seckill.getStartTime();</span><br><span class="line">        LocalDateTime endTime = seckill.getEndTime();</span><br><span class="line">        LocalDateTime nowTime = LocalDateTime.now();</span><br><span class="line">        <span class="comment">//   开始时间大于现在的时候说明没有开始秒杀活动    秒杀活动结束时间小于现在的时间说明秒杀已经结束了</span></span><br><span class="line">        <span class="keyword">if</span> (nowTime.isAfter(startTime) &amp;&amp; nowTime.isBefore(endTime)) &#123;</span><br><span class="line">            <span class="comment">//秒杀开启,返回秒杀商品的id,用给接口加密的md5</span></span><br><span class="line">            String md5 = getMd5(seckillId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">true</span>, md5, seckillId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Exposer(<span class="keyword">false</span>, seckillId, nowTime, startTime, endTime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">+ 写存储过程,然后去`Mysql`控制台执行储存过程</span><br><span class="line"></span><br><span class="line">```sql</span><br><span class="line">-- 秒杀执行储存过程</span><br><span class="line">DELIMITER $$ -- console ; 转换为</span><br><span class="line">$$</span><br><span class="line">-- 定义储存过程</span><br><span class="line">-- 参数： in 参数   out输出参数</span><br><span class="line">-- row_count() 返回上一条修改类型sql(delete,insert,update)的影响行数</span><br><span class="line">-- row_count:<span class="number">0</span>:未修改数据 ; &gt;<span class="number">0</span>:表示修改的行数； &lt;<span class="number">0</span>:sql错误</span><br><span class="line">CREATE PROCEDURE `seckill`.`execute_seckill`</span><br><span class="line">  (IN v_seckill_id BIGINT, IN v_phone BIGINT,</span><br><span class="line">   IN v_kill_time  TIMESTAMP, OUT r_result INT)</span><br><span class="line">  BEGIN</span><br><span class="line">    DECLARE insert_count INT DEFAULT <span class="number">0</span>;</span><br><span class="line">    START TRANSACTION;</span><br><span class="line">    INSERT IGNORE INTO success_killed</span><br><span class="line">    (seckill_id, user_phone, create_time)</span><br><span class="line">    VALUES (v_seckill_id, v_phone, v_kill_time);</span><br><span class="line">    <span class="function">SELECT <span class="title">row_count</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    INTO insert_count</span>;</span><br><span class="line">    IF (insert_count = <span class="number">0</span>)</span><br><span class="line">    THEN</span><br><span class="line">      ROLLBACK;</span><br><span class="line">      SET r_result = -<span class="number">1</span>;</span><br><span class="line">    ELSEIF (insert_count &lt; <span class="number">0</span>)</span><br><span class="line">      THEN</span><br><span class="line">        ROLLBACK;</span><br><span class="line">        SET r_result = -<span class="number">2</span>;</span><br><span class="line">    ELSE</span><br><span class="line">      UPDATE seckill</span><br><span class="line">      SET number = number - <span class="number">1</span></span><br><span class="line">      WHERE seckill_id = v_seckill_id</span><br><span class="line">            AND end_time &gt; v_kill_time</span><br><span class="line">            AND start_time &lt; v_kill_time</span><br><span class="line">            AND number &gt; <span class="number">0</span>;</span><br><span class="line">      <span class="function">SELECT <span class="title">row_count</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      INTO insert_count</span>;</span><br><span class="line">      IF (insert_count = <span class="number">0</span>)</span><br><span class="line">      THEN</span><br><span class="line">        ROLLBACK;</span><br><span class="line">        SET r_result = <span class="number">0</span>;</span><br><span class="line">      ELSEIF (insert_count &lt; <span class="number">0</span>)</span><br><span class="line">        THEN</span><br><span class="line">          ROLLBACK;</span><br><span class="line">          SET r_result = -<span class="number">2</span>;</span><br><span class="line">      ELSE</span><br><span class="line">        COMMIT;</span><br><span class="line">        SET r_result = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      END IF;</span><br><span class="line">    END IF;</span><br><span class="line">  END;</span><br><span class="line">$$</span><br><span class="line">--  储存过程定义结束</span><br><span class="line">DELIMITER ;</span><br><span class="line">SET <span class="meta">@r</span>_result = -<span class="number">3</span>;</span><br><span class="line">--  执行储存过程</span><br><span class="line"><span class="function">CALL <span class="title">execute_seckill</span><span class="params">(<span class="number">1003</span>, <span class="number">13502178891</span>, now()</span>, @r_result)</span>;</span><br><span class="line">-- 获取结果</span><br><span class="line">SELECT <span class="meta">@r</span>_result;</span><br><span class="line">```</span><br><span class="line">+ 在`SeckillMapper`中编写`killProduce()`方法</span><br><span class="line">```java</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  使用储存过程执行秒杀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">killByProcedure</span><span class="params">(Map&lt;String,Object&gt; paramMap)</span></span>;</span><br><span class="line">```</span><br><span class="line">+ 然后在`SeckillMapper.xml`中写`sql`语句</span><br><span class="line"></span><br><span class="line">````xml</span><br><span class="line">&lt;!--调用储存过程--&gt;</span><br><span class="line">    &lt;select id=<span class="string">"killByProcedure"</span> statementType=<span class="string">"CALLABLE"</span>&gt;</span><br><span class="line">        <span class="function">CALL <span class="title">execute_seckill</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                #&#123;seckillId,jdbcType=BIGINT,mode=IN&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">                #&#123;phone,jdbcType=BIGINT,mode=IN&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">                #&#123;killTime,jdbcType=TIMESTAMP,mode=IN&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">                #&#123;result,jdbcType=INTEGER,mode=OUT&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">        )</span></span></span><br><span class="line"><span class="function">    &lt;/select&gt;</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>下一步在<code>SeckillService</code>接口中中编写 <code>killProduce()</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SeckillExecution <span class="title">executeSeckillProcedure</span><span class="params">(<span class="keyword">long</span> seckillId,<span class="keyword">long</span> userPhone,String md5)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>导入<code>commons-collections</code>工具类</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--导入apache工具类--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>然后<code>SeckillServiceImpl</code>实现<code>killProduce()</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckillProcedure</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (md5 == <span class="keyword">null</span> || !md5.equals(getMd5(seckillId))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.DATE_REWRITE);</span><br><span class="line">        &#125;</span><br><span class="line">        LocalDateTime killTime = LocalDateTime.now();</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"seckillId"</span>, seckillId);</span><br><span class="line">        map.put(<span class="string">"phone"</span>, userPhone);</span><br><span class="line">        map.put(<span class="string">"killTime"</span>, killTime);</span><br><span class="line">        map.put(<span class="string">"result"</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 执行储存过程,result被复制</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            seckillMapper.killByProcedure(map);</span><br><span class="line">            <span class="comment">// 获取result</span></span><br><span class="line">            <span class="keyword">int</span> result = MapUtils.getInteger(map, <span class="string">"result"</span>, -<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">                SuccessKilled successKilled = successKilledMapper.queryByIdWithSeckill(seckillId, userPhone);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, successKilled);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.stateOf(result));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>改造执行秒杀<code>executeSeckill</code>方法,减少一道虚拟机<code>GC</code>程序,优化性能</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillExecution <span class="title">executeSeckill</span><span class="params">(<span class="keyword">long</span> seckillId, <span class="keyword">long</span> userPhone, String md5)</span> <span class="keyword">throws</span> SeckillException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (md5 == <span class="keyword">null</span> || !md5.equals(getMd5(seckillId))) &#123;</span><br><span class="line">            logger.error(<span class="string">"秒杀数据被篡改"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SeckillException(<span class="string">"seckill data rewrite"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行秒杀业务逻辑</span></span><br><span class="line">        LocalDateTime nowTIme = LocalDateTime.now();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 记录购买行为</span></span><br><span class="line">            <span class="keyword">int</span> insertCount = successKilledMapper.insertSuccessKilled(seckillId, userPhone);</span><br><span class="line">            <span class="keyword">if</span> (insertCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 重复秒杀</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RepeatKillException(<span class="string">"seckill repeated"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 减库存 ,热点商品的竞争</span></span><br><span class="line">                <span class="keyword">int</span> reduceNumber = seckillMapper.reduceNumber(seckillId, nowTIme);</span><br><span class="line">                <span class="keyword">if</span> (reduceNumber &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"没有更新数据库记录,说明秒杀结束"</span>);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SeckillCloseException(<span class="string">"seckill is closed"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 秒杀成功了,返回那条插入成功秒杀的信息  进行commit</span></span><br><span class="line">                    SuccessKilled successKilled = successKilledMapper.queryByIdWithSeckill(seckillId, userPhone);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.SUCCESS, successKilled);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SeckillCloseException | RepeatKillException e1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>编写<code>SeckillServiceImpl</code>中的<code>killProduce()</code>方法的测试方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeSeckillProcedureTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> seckillId = <span class="number">1001</span>;</span><br><span class="line">       <span class="keyword">long</span> phone = <span class="number">1368011101</span>;</span><br><span class="line">       Exposer exposer = seckillService.exportSeckillUrl(seckillId);</span><br><span class="line">       <span class="keyword">if</span> (exposer.isExposed()) &#123;</span><br><span class="line">           String md5 = exposer.getMd5();</span><br><span class="line">           SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, phone, md5);</span><br><span class="line">           System.out.println(execution.getStateInfo());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ul><li>改造<code>SeckillController</code>中的<code>execute</code>方法调用,把一开始调用普通方法的改成调用储存过程的那个方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;seckillId&#125;/&#123;md5&#125;/execution"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillResult&lt;SeckillExecution&gt; <span class="title">execute</span><span class="params">(@PathVariable(<span class="string">"seckillId"</span>)</span> <span class="keyword">long</span> seckillId,</span></span><br><span class="line"><span class="function">                                                   @<span class="title">PathVariable</span><span class="params">(<span class="string">"md5"</span>)</span> String md5,</span></span><br><span class="line"><span class="function">                                                   @<span class="title">CookieValue</span><span class="params">(value = <span class="string">"userPhone"</span>, required = <span class="keyword">false</span>)</span> Long userPhone) </span>&#123;</span><br><span class="line">        <span class="comment">// 如果用户的手机号码为空的说明没有填写手机号码进行秒杀</span></span><br><span class="line">        <span class="keyword">if</span> (userPhone == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, <span class="string">"没有注册"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据用户的手机号码,``秒杀商品的id跟md5进行秒杀商品,没异常就是秒杀成功</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 这里换成储存过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//            SeckillExecution execution = seckillService.executeSeckill(seckillId, userPhone, md5);</span></span><br><span class="line">            SeckillExecution execution = seckillService.executeSeckillProcedure(seckillId, userPhone, md5);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">true</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RepeatKillException e1) &#123;</span><br><span class="line">            <span class="comment">// 重复秒杀</span></span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.REPEAT_KILL);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SeckillCloseException e2) &#123;</span><br><span class="line">            <span class="comment">// 秒杀关闭</span></span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.END);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SeckillException e) &#123;</span><br><span class="line">            <span class="comment">// 不能判断的异常</span></span><br><span class="line">            SeckillExecution execution = <span class="keyword">new</span> SeckillExecution(seckillId, SeckillStatEnum.INNER_ERROR);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SeckillResult&lt;&gt;(<span class="keyword">false</span>, execution);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果有异常就是秒杀失败</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p> 整个项目的流程是我在看视频的过程中,每当有一个知识点的时候我就在笔记里面记录一个知识点的标题.然后在写详细过程的时候就是根据标题的顺序来进行回忆的,在遇到不是很记得到的地方我也会反过头去看下视频里面的流程,可能会有一些小问题存在.如果项目流程总结中有什么问题欢迎发<code>Issue</code>给我,或者您也可以直接联系我<a href="">sunybyjava@gmail.com</a></p><h3 id="感谢您的阅读"><a href="#感谢您的阅读" class="headerlink" title="感谢您的阅读"></a>感谢您的阅读</h3>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;seckill&quot;&gt;&lt;a href=&quot;#seckill&quot; class=&quot;headerlink&quot; title=&quot;seckill&quot;&gt;&lt;/a&gt;seckill&lt;/h1&gt;&lt;p&gt;一个整合SSM框架的高并发和商品秒杀项目,学习目前较流行的Java框架组合实现高并发秒杀API&lt;/p
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2018/11/26/hello-world/"/>
    <id>http://yoursite.com/2018/11/26/hello-world/</id>
    <published>2018-11-26T03:27:55.302Z</published>
    <updated>2018-11-26T03:27:55.302Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
</feed>
